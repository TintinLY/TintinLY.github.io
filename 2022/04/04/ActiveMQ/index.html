<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/noun-dog-3491961.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/noun-dog-3491961.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/noun-dog-3491961.png">
  <link rel="mask-icon" href="/images/noun-dog-3491961.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="0 前置知识MQ产品种类 ||编程语言|    消息中间件 编程语言    Kafka Java&#x2F;Scale   RabbitMQ erlang   RocketMQ Java   ActiveMQ Java">
<meta property="og:type" content="article">
<meta property="og:title" content="ActiveMQ">
<meta property="og:url" content="http://example.com/2022/04/04/ActiveMQ/index.html">
<meta property="og:site_name" content="小破城">
<meta property="og:description" content="0 前置知识MQ产品种类 ||编程语言|    消息中间件 编程语言    Kafka Java&#x2F;Scale   RabbitMQ erlang   RocketMQ Java   ActiveMQ Java">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211224111509083.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211224203701964.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211224204539276.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211226125602539.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211226143357100.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211226144208629.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211226144224900.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211226151721490.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211226152853344.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211226160423820.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211226160429926.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211226175917458.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211227162921882.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211228002253638.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211228194157206.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211229183222902.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211229192338872.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211229224135978.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211229224057758.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211230035948183.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211230133810680.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211230151943446.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211230203911552.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211230203923363.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211230210844650.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211230214753485.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211231135735442.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211231140136788.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211231141647433.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211231155350713.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20220101161150929.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20220101160849517.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20220101162248225.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20220101161150929.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20220101163114978.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20220101163651574.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20220101163749051.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20220101163737840.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20220101163906587.png">
<meta property="og:image" content="http://example.com/2022/04/04/ActiveMQ/image-20220101163919118.png">
<meta property="article:published_time" content="2022-04-04T12:11:42.000Z">
<meta property="article:modified_time" content="2022-04-04T14:33:47.055Z">
<meta property="article:author" content="丁丁">
<meta property="article:tag" content="消息中间件">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/04/04/ActiveMQ/image-20211224111509083.png">

<link rel="canonical" href="http://example.com/2022/04/04/ActiveMQ/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>ActiveMQ | 小破城</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="小破城" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  
  <div class="container use-motion">
    <div class="headband"></div>
    <a target="_blank" rel="noopener" href="https://github.com/tintinly" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">小破城</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/04/ActiveMQ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="丁丁">
      <meta itemprop="description" content="想睡的时候能睡着">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小破城">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ActiveMQ
        </h1>

        <div class="post-meta">
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-04-04 20:11:42 / 修改时间：22:33:47" itemprop="dateCreated datePublished" datetime="2022-04-04T20:11:42+08:00">2022-04-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%94%9F%E6%80%81/" itemprop="url" rel="index"><span itemprop="name">微服务生态</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/04/04/ActiveMQ/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/04/04/ActiveMQ/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>41k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>37 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="0-前置知识"><a href="#0-前置知识" class="headerlink" title="0 前置知识"></a>0 前置知识</h1><p>MQ产品种类</p>
<p>||编程语言|</p>
<table>
<thead>
<tr>
<th>消息中间件</th>
<th>编程语言</th>
</tr>
</thead>
<tbody><tr>
<td>Kafka</td>
<td>Java&#x2F;Scale</td>
</tr>
<tr>
<td>RabbitMQ</td>
<td>erlang</td>
</tr>
<tr>
<td>RocketMQ</td>
<td>Java</td>
</tr>
<tr>
<td>ActiveMQ</td>
<td>Java</td>
</tr>
</tbody></table>
<span id="more"></span>

<p>Kafka<br>RabbitMQ<br>RocketMQ<br>ActiveMQ</p>
<p>技术维度</p>
<p><img src="/2022/04/04/ActiveMQ/image-20211224111509083.png" alt="image-20211224111509083"></p>
<h1 id="1-入门概述"><a href="#1-入门概述" class="headerlink" title="1 入门概述"></a>1 入门概述</h1><h2 id="1-1-为什么要引入消息中间件"><a href="#1-1-为什么要引入消息中间件" class="headerlink" title="1.1 为什么要引入消息中间件"></a>1.1 为什么要引入消息中间件</h2><p>系统之间<strong>直接调用</strong>实际工程落地，存在的问题</p>
<p>系统之间接口耦合比较严重<br>面对大流量并发时，容易被冲垮<br>等待同步存在性能问题</p>
<p>引入消息中间件</p>
<p>解决耦合调用问题<br>异步模型<br>抵御洪峰流量，达到保护主业务的目的，流量削峰</p>
<h2 id="1-2-什么是消息中间件"><a href="#1-2-什么是消息中间件" class="headerlink" title="1.2 什么是消息中间件"></a>1.2 什么是消息中间件</h2><p>是指利用高效可靠的消息传递机制进行与平台无关的数据交流，并基于数据通信来进行分布式系统的集成。<br>通过提供<strong>消息传递</strong>和<strong>消息排队</strong>模型在分布式环境下提供应用解耦、弹性伸缩、冗余存储、流量削峰、异步通信、数据同步等功能。</p>
<p>发送者把消息发送给消息服务器，消息服务器将消息存放在若干<strong>队列&#x2F;主题</strong>中，在合适的时候，消息服务器会将消息转发给接受者。<br>在这个过程中，发送和接受是<strong>异步</strong>的，也就是发送无需等待，而且发送者和接受者的生命周期也没有必然关系；<br>尤其在发布pub&#x2F;订阅sub模式下，也可以完成一对多的通信，即让一个消息有多个接受者。</p>
<p><img src="/2022/04/04/ActiveMQ/image-20211224203701964.png" alt="image-20211224203701964"></p>
<h2 id="1-3-特点"><a href="#1-3-特点" class="headerlink" title="1.3 特点"></a>1.3 特点</h2><ul>
<li><p>采用异步处理模式</p>
</li>
<li><p>应用系统之间解耦</p>
<ul>
<li>发送者和接收者不必了解对方，只需确认消息</li>
<li>发送者和接收者不必同时在线</li>
</ul>
</li>
<li><p><img src="/2022/04/04/ActiveMQ/image-20211224204539276.png" alt="image-20211224204522217"></p>
</li>
</ul>
<h2 id="1-4-官网"><a href="#1-4-官网" class="headerlink" title="1.4 官网"></a>1.4 官网</h2><p><a target="_blank" rel="noopener" href="https://activemq.apache.org/">ActiveMQ (apache.org)</a></p>
<h2 id="1-5-安装启动"><a href="#1-5-安装启动" class="headerlink" title="1.5 安装启动"></a>1.5 安装启动</h2><p>安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[tintin@hadoop102 ~]$ tar -zxvf apache-activemq-5.16.3-bin.tar.gz -C /opt/module</span><br><span class="line">[tintin@hadoop102 activemq-5.16.3]$ <span class="built_in">mv</span> apache-activemq-5.16.3/ activemq-5.16.3</span><br></pre></td></tr></table></figure>

<p>启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[tintin@hadoop102 activemq-5.16.3]$ bin/activemq start</span><br></pre></td></tr></table></figure>

<p>默认端口61616</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[tintin@hadoop102 activemq-5.16.3]$ ps -ef | grep activemq</span><br><span class="line">tintin     6840      1  0 12月25 pts/0  00:00:36 /opt/module/jdk1.8.0_311/bin/java -Xms64M -Xmx1G -Djava.util.logging.config.file=logging.properties -Djava.security.auth.login.config=/opt/module/activemq-5.16.3//conf/login.config -Dcom.sun.management.jmxremote -Djava.awt.headless=<span class="literal">true</span> -Djava.io.tmpdir=/opt/module/activemq-5.16.3//tmp -Dactivemq.classpath=/opt/module/activemq-5.16.3//conf:/opt/module/activemq-5.16.3//../lib/: -Dactivemq.home=/opt/module/activemq-5.16.3/ -Dactivemq.base=/opt/module/activemq-5.16.3/ -Dactivemq.conf=/opt/module/activemq-5.16.3//conf -Dactivemq.data=/opt/module/activemq-5.16.3//data -jar /opt/module/activemq-5.16.3//bin/activemq.jar start</span><br><span class="line">tintin     8662   2072  0 00:19 pts/0    00:00:00 grep --color=auto activemq</span><br><span class="line">[tintin@hadoop102 activemq-5.16.3]$ netstat -anp|grep 61616</span><br><span class="line">(Not all processes could be identified, non-owned process info</span><br><span class="line"> will not be shown, you would have to be root to see it all.)</span><br><span class="line">tcp6       0      0 :::61616                :::*                    LISTEN      6840/java       </span><br><span class="line">[tintin@hadoop102 activemq-5.16.3]$ lsof -i:61616</span><br><span class="line">COMMAND  PID   USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">java    6840 tintin  137u  IPv6  79095      0t0  TCP *:61616 (LISTEN)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>带运行日志启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[tintin@hadoop102 activemq-5.16.3]$ bin/activemq start &gt; myrunmq.log</span><br></pre></td></tr></table></figure>

<h2 id="1-6-前台页面"><a href="#1-6-前台页面" class="headerlink" title="1.6 前台页面"></a>1.6 前台页面</h2><ol>
<li>发现8161对应的ip地址是127.0.0.1，这个地址一般都是localhost的地址，所以需要把这个地址改成0.0.0.0，即广播地址，这样通过本机ip地址就可以访问到了，所以需要修改bin&#x2F;conf&#x2F;jetty.xml</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;jettyPort&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.activemq.web.WebConsolePort&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;start&quot;</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!-- the default port number for the web console --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;host&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0.0.0.0&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;port&quot;</span> <span class="attr">value</span>=<span class="string">&quot;8161&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>关闭防火墙或开放端口61616、8161</li>
</ol>
<p>采用61616端口提供JMS服务<br>采用8161端口提供管理控制台服务</p>
<p><a href="%E6%9D%82%E8%AE%B0.md#linux%E9%98%B2%E7%81%AB%E5%A2%99%E5%91%BD%E4%BB%A4">linux防火墙命令</a></p>
<ol start="3">
<li><p>访问服务器的端口8161<a target="_blank" rel="noopener" href="http://192.168.10.102:8161/">http://192.168.10.102:8161</a></p>
</li>
<li><p>输入默认账号密码admin</p>
</li>
</ol>
<p><img src="/2022/04/04/ActiveMQ/image-20211226125602539.png" alt="image-20211226125602539"></p>
<h1 id="2-Java实现ActiveMQ通讯"><a href="#2-Java实现ActiveMQ通讯" class="headerlink" title="2 Java实现ActiveMQ通讯"></a>2 Java实现ActiveMQ通讯</h1><h2 id="2-1-依赖"><a href="#2-1-依赖" class="headerlink" title="2.1 依赖"></a>2.1 依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        activemq所需必备依赖--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.activemq/activemq-all --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.activemq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activemq-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.15.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.xbean/xbean-spring --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.xbean<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xbean-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--        junit/log4j基础依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.25<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.16.18<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-2-JMS编码总体架构"><a href="#2-2-JMS编码总体架构" class="headerlink" title="2.2 JMS编码总体架构"></a>2.2 JMS编码总体架构</h2><p>Java消息服务（Java Message Service）</p>
<p><img src="/2022/04/04/ActiveMQ/image-20211226143357100.png" alt="image-20211226143357100"></p>
<h2 id="2-3-目的地Destination"><a href="#2-3-目的地Destination" class="headerlink" title="2.3 目的地Destination"></a>2.3 目的地Destination</h2><p>队列（点对点）</p>
<p><img src="/2022/04/04/ActiveMQ/image-20211226144208629.png" alt="image-20211226144208629"></p>
<p>主题（订阅与发布）</p>
<p><img src="/2022/04/04/ActiveMQ/image-20211226144224900.png" alt="image-20211226144224900"></p>
<h2 id="2-4-队列实现案例"><a href="#2-4-队列实现案例" class="headerlink" title="2.4 队列实现案例"></a>2.4 队列实现案例</h2><h3 id="2-4-1-队列生产者"><a href="#2-4-1-队列生产者" class="headerlink" title="2.4.1 队列生产者"></a>2.4.1 队列生产者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JmsProducer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ACTIVE_MQ</span> <span class="operator">=</span> <span class="string">&quot;tcp://192.168.10.102:61616&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;queue1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> JMSException &#123;</span><br><span class="line">        <span class="comment">//根据给定的url地址，创建连接工厂</span></span><br><span class="line">        <span class="type">ActiveMQConnectionFactory</span> <span class="variable">activeMQConnectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActiveMQConnectionFactory</span>(ACTIVE_MQ);</span><br><span class="line">        <span class="comment">//获取连接并启动访问</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> activeMQConnectionFactory.createConnection();</span><br><span class="line">        connection.start();</span><br><span class="line">        <span class="comment">//创建会话session 设置事务与签收</span></span><br><span class="line">        <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> connection.createSession(<span class="literal">false</span>, Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">        <span class="comment">//创建目的地队列</span></span><br><span class="line">        <span class="type">Queue</span> <span class="variable">queue</span> <span class="operator">=</span> session.createQueue(queueName);</span><br><span class="line">        <span class="comment">//创建消息生产者</span></span><br><span class="line">        <span class="type">MessageProducer</span> <span class="variable">messageProducer</span> <span class="operator">=</span> session.createProducer(queue);</span><br><span class="line">        <span class="comment">//生产者生产消息到mq队列中</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="comment">//创建消息</span></span><br><span class="line">            <span class="type">TextMessage</span> <span class="variable">textMessage</span> <span class="operator">=</span> session.createTextMessage(<span class="string">&quot;msg&quot;</span> + i + <span class="number">1</span>);</span><br><span class="line">            messageProducer.send(textMessage);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//关闭资源</span></span><br><span class="line">        messageProducer.close();</span><br><span class="line">        session.close();</span><br><span class="line">        connection.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;消息发送到了MQ成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/04/04/ActiveMQ/image-20211226151721490.png" alt="image-20211226151721490"></p>
<h3 id="2-4-2-队列消费者"><a href="#2-4-2-队列消费者" class="headerlink" title="2.4.2 队列消费者"></a>2.4.2 队列消费者</h3><p><strong>同步阻塞方式receive()</strong><br>订阅者或接收者调用MessageConsumer 的receive(）方法来接收消息，receive方法在能够接收到消息之前（或超时之前）将一直阻塞。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JmsConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ACTIVE_MQ</span> <span class="operator">=</span> <span class="string">&quot;tcp://192.168.10.102:61616&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;queue1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> JMSException &#123;</span><br><span class="line">        <span class="comment">//根据给定的url地址，创建连接工厂</span></span><br><span class="line">        <span class="type">ActiveMQConnectionFactory</span> <span class="variable">activeMQConnectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActiveMQConnectionFactory</span>(ACTIVE_MQ);</span><br><span class="line">        <span class="comment">//获取连接并启动访问</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> activeMQConnectionFactory.createConnection();</span><br><span class="line">        connection.start();</span><br><span class="line">        <span class="comment">//创建会话session 设置事务与签收</span></span><br><span class="line">        <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> connection.createSession(<span class="literal">false</span>, Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">        <span class="comment">//创建目的地队列</span></span><br><span class="line">        <span class="type">Queue</span> <span class="variable">queue</span> <span class="operator">=</span> session.createQueue(queueName);</span><br><span class="line">        <span class="comment">//创建消息消费者</span></span><br><span class="line">        <span class="type">MessageConsumer</span> <span class="variable">messageConsumer</span> <span class="operator">=</span> session.createConsumer(queue);</span><br><span class="line">        <span class="comment">//接受消息</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">//设置延时不等待</span></span><br><span class="line">            <span class="type">TextMessage</span> <span class="variable">textMessage</span> <span class="operator">=</span>(TextMessage) messageConsumer.receive(<span class="number">4000L</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != textMessage) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;消费者接收到消息：&quot;</span> + textMessage.getText());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//关闭资源</span></span><br><span class="line">        messageConsumer.close();</span><br><span class="line">        session.close();</span><br><span class="line">        connection.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/04/04/ActiveMQ/image-20211226152853344.png" alt="image-20211226152853344"></p>
<p>4s内消费者仍在接收消息，4s后不在接收</p>
<p><strong>异步非阻塞方式 监听器onMessage()</strong><br>订阅者或接收者通过MessageConsumer的setMessageListener(MessageListener listener)注册一个消息监听器，<br>当消息到达之后，系统自动调用监听器MessageListener的onMessage(Message message)方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//监听消息</span></span><br><span class="line">      messageConsumer.setMessageListener(message -&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="literal">null</span> != message &amp;&amp; message <span class="keyword">instanceof</span> TextMessage) &#123;</span><br><span class="line">              <span class="type">TextMessage</span> <span class="variable">textMessage</span> <span class="operator">=</span> (TextMessage) message;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  System.out.println(<span class="string">&quot;消费者接收到消息：&quot;</span> + textMessage.getText());</span><br><span class="line">              &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">                  e.printStackTrace();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; );</span><br><span class="line"></span><br><span class="line">      System.in.read();<span class="comment">//保证进程不停止，按任意键退出</span></span><br></pre></td></tr></table></figure>

<blockquote>
<ol>
<li>先生产消息，只启动1号消费者，再启动2号消费者，问题：2号消费者还能消费消息吗？ no</li>
<li>先启动2个消费者，再生产6条消息，请向，消费情况如何？轮询<br><img src="/2022/04/04/ActiveMQ/image-20211226160423820.png" alt="image-20211226160423820"></li>
</ol>
<p><img src="/2022/04/04/ActiveMQ/image-20211226160429926.png" alt="image-20211226160429926"></p>
</blockquote>
<h3 id="2-4-3-特点"><a href="#2-4-3-特点" class="headerlink" title="2.4.3 特点"></a>2.4.3 特点</h3><p>点对点消息传递域的特点如下：<br>（1）每个消息只能有一个消费者，类似1对1的关系。好比个人快递自己领取自己的。<br>（2）消息的生产者和消费者之间<strong>没有时间上的相关性</strong>。无论消费者在生产者发送消息的时候是否处于运行状态，消费<br>者都可以提取消息。好比我们的发送短信，发送者发送后不见得接收者会即收即看。<br>（3）消息被消费后队列中不会再存储，所以消费者不会消费到已经被消费掉的消息。</p>
<h2 id="2-5-主题实现案例"><a href="#2-5-主题实现案例" class="headerlink" title="2.5 主题实现案例"></a>2.5 主题实现案例</h2><h3 id="2-5-1-发布主题生产者"><a href="#2-5-1-发布主题生产者" class="headerlink" title="2.5.1 发布主题生产者"></a>2.5.1 发布主题生产者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JmsProducer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ACTIVE_MQ</span> <span class="operator">=</span> <span class="string">&quot;tcp://192.168.10.102:61616&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TOPIC_NAME</span> <span class="operator">=</span> <span class="string">&quot;topic1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> JMSException &#123;</span><br><span class="line">        <span class="comment">//根据给定的url地址，创建连接工厂</span></span><br><span class="line">        <span class="type">ActiveMQConnectionFactory</span> <span class="variable">activeMQConnectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActiveMQConnectionFactory</span>(ACTIVE_MQ);</span><br><span class="line">        <span class="comment">//获取连接并启动访问</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> activeMQConnectionFactory.createConnection();</span><br><span class="line">        connection.start();</span><br><span class="line">        <span class="comment">//创建会话session 设置事务与签收</span></span><br><span class="line">        <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> connection.createSession(<span class="literal">false</span>, Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">        <span class="comment">//创建目的地队列</span></span><br><span class="line">        <span class="type">Topic</span> <span class="variable">topic</span> <span class="operator">=</span> session.createTopic(TOPIC_NAME);</span><br><span class="line">        <span class="comment">//创建消息生产者</span></span><br><span class="line">        <span class="type">MessageProducer</span> <span class="variable">messageProducer</span> <span class="operator">=</span> session.createProducer(topic);</span><br><span class="line">        <span class="comment">//生产者生产消息到mq队列中</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">            <span class="comment">//创建消息</span></span><br><span class="line">            <span class="type">TextMessage</span> <span class="variable">textMessage</span> <span class="operator">=</span> session.createTextMessage(<span class="string">&quot;msg&quot;</span> + (i + <span class="number">1</span>));</span><br><span class="line">            messageProducer.send(textMessage);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//关闭资源</span></span><br><span class="line">        messageProducer.close();</span><br><span class="line">        session.close();</span><br><span class="line">        connection.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;消息发送到了MQ成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-5-2-订阅订阅消费者"><a href="#2-5-2-订阅订阅消费者" class="headerlink" title="2.5.2 订阅订阅消费者"></a>2.5.2 订阅订阅消费者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JmsConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ACTIVE_MQ</span> <span class="operator">=</span> <span class="string">&quot;tcp://192.168.10.102:61616&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TOPIC_NAME</span> <span class="operator">=</span> <span class="string">&quot;topic1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> JMSException, IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;三号消费者启动&quot;</span>);</span><br><span class="line">        <span class="comment">//根据给定的url地址，创建连接工厂</span></span><br><span class="line">        <span class="type">ActiveMQConnectionFactory</span> <span class="variable">activeMQConnectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActiveMQConnectionFactory</span>(ACTIVE_MQ);</span><br><span class="line">        <span class="comment">//获取连接并启动访问</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> activeMQConnectionFactory.createConnection();</span><br><span class="line">        connection.start();</span><br><span class="line">        <span class="comment">//创建会话session 设置事务与签收</span></span><br><span class="line">        <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> connection.createSession(<span class="literal">false</span>, Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">        <span class="comment">//创建目的地队列</span></span><br><span class="line">        <span class="type">Topic</span> <span class="variable">topic</span> <span class="operator">=</span> session.createTopic(TOPIC_NAME);</span><br><span class="line">        <span class="comment">//创建消息消费者</span></span><br><span class="line">        <span class="type">MessageConsumer</span> <span class="variable">messageConsumer</span> <span class="operator">=</span> session.createConsumer(topic);</span><br><span class="line"><span class="comment">//        //接受消息</span></span><br><span class="line"><span class="comment">//        while (true) &#123;</span></span><br><span class="line"><span class="comment">//            //设置延时不等待</span></span><br><span class="line"><span class="comment">//            TextMessage textMessage =(TextMessage) messageConsumer.receive(4000L);</span></span><br><span class="line"><span class="comment">//            if (null != textMessage) &#123;</span></span><br><span class="line"><span class="comment">//                System.out.println(&quot;消费者接收到消息：&quot; + textMessage.getText());</span></span><br><span class="line"><span class="comment">//            &#125; else &#123;</span></span><br><span class="line"><span class="comment">//                break;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//监听消息</span></span><br><span class="line">        messageConsumer.setMessageListener(message -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != message &amp;&amp; message <span class="keyword">instanceof</span> TextMessage) &#123;</span><br><span class="line">                <span class="type">TextMessage</span> <span class="variable">textMessage</span> <span class="operator">=</span> (TextMessage) message;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;三号消费者接收到消息：&quot;</span> + textMessage.getText());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; );</span><br><span class="line"></span><br><span class="line">        System.in.read();<span class="comment">//保证进程不停止，按任意键退出</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//关闭资源</span></span><br><span class="line">        messageConsumer.close();</span><br><span class="line">        session.close();</span><br><span class="line">        connection.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/04/04/ActiveMQ/image-20211226175917458.png" alt="image-20211226175917458"></p>
<h3 id="2-5-3-特点"><a href="#2-5-3-特点" class="headerlink" title="2.5.3 特点"></a>2.5.3 特点</h3><p>发布订阅消息传递域的特点如下：<br>（1）生产者将消息发布到topic中，每个消息可以有多个消费者，属于1：N的关系<br>（2）生产者和消费者之间<strong>有时间上的相关性</strong>。订阅某一个主题的消费者只能消费自它订阅之后发布的消息。<br>（3）生产者生产时，topic不保存消息它是无状态的不落地，假如无人订阅就去生产，那就是一条废消息，所以，一般先启动消费者再启动生产者。<br>JMS规范允许客户创建持久订阅，这在一定程度上放松了时间上的相关性要求。持久订阅允许消费者消费它在未处于激活状态时发送的消息。。一句话，好比我们的微信公众号订阅</p>
<h2 id="2-6-两大模式对比"><a href="#2-6-两大模式对比" class="headerlink" title="2.6 两大模式对比"></a>2.6 两大模式对比</h2><table>
<thead>
<tr>
<th></th>
<th>Topic模式</th>
<th>Queue模式</th>
</tr>
</thead>
<tbody><tr>
<td>工作模式</td>
<td>订阅-发布”模式，如果当前没有订阅者，消息将会被丢弃。如果有多个订阅者，那么这些订阅者都会收到消息</td>
<td>负载均衡”模式，如果当前没有消费者，消息也不会丢弃；如果有多个消费者，那么一条消息也只会发送给其中一个消费者，并且要求消费者ack信息。</td>
</tr>
<tr>
<td>有无状态</td>
<td>无状态</td>
<td>Queue数据默认会在mq服务器上以文件形式保存，比如Active MQ股保存在SAMQ HOME\datalkr-storeldata下面。也可以配置成DB存储。</td>
</tr>
<tr>
<td>传递完整性</td>
<td>如果没有订阅者，消息将会被丢弃</td>
<td>消息不会丢弃</td>
</tr>
<tr>
<td>处理效率</td>
<td>由于消息要按照订阅者的数量进行复制，所以处理性能会随着订阅者的增加而明显降低，并且还要结合不同消息协议自身的姓能差异</td>
<td>由于一条消息只发送给一个消费者，所以就算消费者再多，性能也不会有明显降低。当然不忄消息协议的具体性能也是有差异的</td>
</tr>
</tbody></table>
<h1 id="3-JMS规范与落地产品"><a href="#3-JMS规范与落地产品" class="headerlink" title="3 JMS规范与落地产品"></a>3 JMS规范与落地产品</h1><h2 id="3-1-JMS"><a href="#3-1-JMS" class="headerlink" title="3.1 JMS"></a>3.1 JMS</h2><p>Java Message Service(Java消息服务是JavaEE中的一个技术)</p>
<p>Java消息服务指的是两个应用程序之间进行异步通信。它为标准消息协议和消息服务提供了一组通用接口，包括创建、发送、读取消息等，用于支持JAVA应用程序开发。在JavaEE中，当两个应用程序使用JMS进行通信时，它们之间并不是直接相连的，而是通过一个共同的消息收发服务组件关联起来以达到解耦&#x2F;异步削峰的效果。</p>
<h2 id="3-2-其他消息中间件"><a href="#3-2-其他消息中间件" class="headerlink" title="3.2  其他消息中间件"></a>3.2  其他消息中间件</h2><table>
<thead>
<tr>
<th>特性</th>
<th>ActiveMQ</th>
<th>RabbitMQ</th>
<th>Kafka</th>
<th>RocketMQ</th>
</tr>
</thead>
<tbody><tr>
<td>Producer-Consumer</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>Publish-Subscribe</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>Request-Reply</td>
<td>支持</td>
<td>支持</td>
<td>-</td>
<td>支持</td>
</tr>
<tr>
<td>API完备性</td>
<td>高</td>
<td>高</td>
<td>高</td>
<td>低（静态配置）</td>
</tr>
<tr>
<td>多语言支持</td>
<td>支持，Java优先</td>
<td>语言无关</td>
<td>支持，Java优先</td>
<td>支持</td>
</tr>
<tr>
<td>单机吞吐量</td>
<td>万级</td>
<td>万级</td>
<td>十万级</td>
<td>单机万级</td>
</tr>
<tr>
<td>消息延迟</td>
<td>-</td>
<td>微妙级</td>
<td>毫秒级</td>
<td>-</td>
</tr>
<tr>
<td>可用性</td>
<td>高（主从）</td>
<td>高（主从）</td>
<td>非常高（分布式）</td>
<td>高</td>
</tr>
<tr>
<td>消息丢失</td>
<td>-</td>
<td>低</td>
<td>理论不会</td>
<td>-</td>
</tr>
<tr>
<td>消息重复</td>
<td>-</td>
<td>可控制</td>
<td>理论上会有重复</td>
<td>-</td>
</tr>
<tr>
<td>文档完备性</td>
<td>高</td>
<td>高</td>
<td>高</td>
<td>中</td>
</tr>
<tr>
<td>提供快速入门</td>
<td>有</td>
<td>有</td>
<td>有</td>
<td>无</td>
</tr>
<tr>
<td>首次部署难度</td>
<td>-</td>
<td>低</td>
<td>中</td>
<td>高</td>
</tr>
</tbody></table>
<h2 id="3-3-组成结构和特点"><a href="#3-3-组成结构和特点" class="headerlink" title="3.3 组成结构和特点"></a>3.3 组成结构和特点</h2><p><strong>JMS provider</strong> 实现JMs接口和规范的消息中间件，也就是我们的MQ服务器</p>
<p><strong>JMS producer</strong> 消息生产者，创建和发送JMS消息的客户端应用</p>
<p><strong>JMS consumer</strong> 消息消费者，接收和处理JMS消息的客户端应用</p>
<p><strong>JMS message</strong> </p>
<ul>
<li>消息头<ul>
<li>JMSDestination：消息发送的目的地,主要是指Queue和Topic</li>
<li>JMSDeliveryMode：持久模式和非持久模式</li>
<li>JMSExpiration：一定时间过期 ttl为0表示永不过期 如果发送后，在消息过期时间之后消息还没有被发送到，消息被清除</li>
<li>JMSPriority：消息优先级 0-4普通 5-9加急，加急一定先于普通到达</li>
<li>JMSMessage：唯一识别每个消息的标识由MQ产生。</li>
</ul>
</li>
<li>消息体 封装具体的消息数据  发送和接收消息体类型必须一致对应<ul>
<li><p>TextMessage：普通字符串消息，包含一个string</p>
</li>
<li><p>MapMessage：一个Map类型的消息，key为string类型，，而值为Java的基本类型</p>
</li>
<li><p>BytesMessage：二进制数组消息，包含一个byte[]</p>
</li>
<li><p>StreamMessage：Java数据流消息，用标准流操作来顺序的填充和读取。</p>
</li>
<li><p>ObjectMessage：对象消息，包含一个可序列化的Java对象</p>
</li>
</ul>
</li>
<li>消息属性<ul>
<li>如果需要除消息头字段以外的值，那么可以使用消息属性</li>
<li>识别&#x2F;去重&#x2F;重点标注等操作非常有用的方法</li>
<li>他们是以属性名和属性值对的形式制定的。可以将属性是为消息头得扩展，属性指定一些消息头没有包括的<strong>附加信息</strong>，比如可以在属性里指定消息选择器。message.setStringProperty()</li>
</ul>
</li>
</ul>
<h2 id="3-4-可靠性"><a href="#3-4-可靠性" class="headerlink" title="3.4 可靠性"></a>3.4 可靠性</h2><h3 id="3-4-1-Persistent持久性"><a href="#3-4-1-Persistent持久性" class="headerlink" title="3.4.1 Persistent持久性"></a>3.4.1 Persistent持久性</h3><p><strong>参数设置</strong></p>
<ul>
<li><p>非持久：messageProducer.setDeliveryMode(DeliveryMode.NON_PERSISTENT) 当服务器宕机或者订阅者离线，消息不存在</p>
</li>
<li><p>持久：messageProducer.setDeliveryMode(DeliveryMode.PERSISTENT) 当服务器宕机或者订阅者离线，消息依然存在</p>
</li>
</ul>
<blockquote>
<p>MQ挂了，消息的持久化和丢失情况如何？</p>
<p>队列默认传送模式为持久化，保证了消息只被传送一次且成功使用一次。</p>
<p>主题中，先运行一次订阅者者，此时处于在线状态。然后再运行发布者者发送信息，此时，无论订阅者是否在线，都会接收到，不在线的话，下次连接的时候，会把没有收过的消息都接收下来。</p>
</blockquote>
<p>主题持久化订阅者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JmsConsumer_Persist</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ACTIVE_MQ</span> <span class="operator">=</span> <span class="string">&quot;tcp://192.168.10.102:61616&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TOPIC_NAME</span> <span class="operator">=</span> <span class="string">&quot;topic_persist&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> JMSException, IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;持久化订阅者消费者启动&quot;</span>);</span><br><span class="line">        <span class="comment">//根据给定的url地址，创建连接工厂</span></span><br><span class="line">        <span class="type">ActiveMQConnectionFactory</span> <span class="variable">activeMQConnectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActiveMQConnectionFactory</span>(ACTIVE_MQ);</span><br><span class="line">        <span class="comment">//获取连接并启动访问</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> activeMQConnectionFactory.createConnection();</span><br><span class="line">        connection.setClientID(<span class="string">&quot;持久化订阅者消费者&quot;</span>);</span><br><span class="line">        <span class="comment">//创建会话session 设置事务与签收</span></span><br><span class="line">        <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> connection.createSession(<span class="literal">false</span>, Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">        <span class="comment">//创建目的地队列</span></span><br><span class="line">        <span class="type">Topic</span> <span class="variable">topic</span> <span class="operator">=</span> session.createTopic(TOPIC_NAME);</span><br><span class="line">        <span class="comment">//持久化订阅者</span></span><br><span class="line">        <span class="type">TopicSubscriber</span> <span class="variable">durableSubscriber</span> <span class="operator">=</span> session.createDurableSubscriber(topic, <span class="string">&quot;remarked&quot;</span>);</span><br><span class="line"></span><br><span class="line">        connection.start();</span><br><span class="line"></span><br><span class="line">        <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> durableSubscriber.receive();</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">null</span> != message) &#123;</span><br><span class="line">            <span class="type">TextMessage</span> <span class="variable">textMessage</span> <span class="operator">=</span> (TextMessage) message;</span><br><span class="line">            System.out.println(<span class="string">&quot;接收到持久化消息&quot;</span> + textMessage.getText());</span><br><span class="line">            message = durableSubscriber.receive(<span class="number">5000L</span>);<span class="comment">//由于发布消息有限，接收消息等待超时后，订阅者将离线</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.in.read();<span class="comment">//保证进程不停止，按任意键退出</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//关闭资源</span></span><br><span class="line">        durableSubscriber.close();</span><br><span class="line">        session.close();</span><br><span class="line">        connection.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>主题持久化发布者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JmsProducer_Persist</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ACTIVE_MQ</span> <span class="operator">=</span> <span class="string">&quot;tcp://192.168.10.102:61616&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TOPIC_NAME</span> <span class="operator">=</span> <span class="string">&quot;topic_persist&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> JMSException &#123;</span><br><span class="line">        <span class="comment">//根据给定的url地址，创建连接工厂</span></span><br><span class="line">        <span class="type">ActiveMQConnectionFactory</span> <span class="variable">activeMQConnectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActiveMQConnectionFactory</span>(ACTIVE_MQ);</span><br><span class="line">        <span class="comment">//获取连接并启动访问</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> activeMQConnectionFactory.createConnection();</span><br><span class="line">        <span class="comment">//创建会话session 设置事务与签收</span></span><br><span class="line">        <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> connection.createSession(<span class="literal">false</span>, Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">        <span class="comment">//创建目的地队列</span></span><br><span class="line">        <span class="type">Topic</span> <span class="variable">topic</span> <span class="operator">=</span> session.createTopic(TOPIC_NAME);</span><br><span class="line">        <span class="comment">//创建消息生产者</span></span><br><span class="line">        <span class="type">MessageProducer</span> <span class="variable">messageProducer</span> <span class="operator">=</span> session.createProducer(topic);</span><br><span class="line">        <span class="comment">//设置持久化传输模式</span></span><br><span class="line">        messageProducer.setDeliveryMode(DeliveryMode.PERSISTENT);</span><br><span class="line"></span><br><span class="line">        connection.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//生产者生产消息到mq队列中</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">            <span class="comment">//创建消息</span></span><br><span class="line">            <span class="type">TextMessage</span> <span class="variable">textMessage</span> <span class="operator">=</span> session.createTextMessage(<span class="string">&quot;msg&quot;</span> + (i + <span class="number">1</span>));</span><br><span class="line">            messageProducer.send(textMessage);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//关闭资源</span></span><br><span class="line">        messageProducer.close();</span><br><span class="line">        session.close();</span><br><span class="line">        connection.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;持久化消息发布到了MQ成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/04/04/ActiveMQ/image-20211227162921882.png" alt="image-20211227162921882"></p>
<h3 id="3-4-2-Transaction事务"><a href="#3-4-2-Transaction事务" class="headerlink" title="3.4.2 Transaction事务"></a>3.4.2 Transaction事务</h3><p><strong>参数设置</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//事务与签收</span></span><br><span class="line"><span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> connection.createSession(<span class="literal">false</span>, Session.AUTO_ACKNOWLEDGE);</span><br></pre></td></tr></table></figure>

<p><strong>对于生产者</strong></p>
<ul>
<li><p>非事务：false 每一次messageProducer.send(textMessage);都会提交</p>
</li>
<li><p>事务：true 通过session.commit()进行提交，通过session.rollback()进行回滚</p>
</li>
</ul>
<p><strong>对于消费者</strong></p>
<ul>
<li><p>非事务：false 每一次messageConsumer.receive()，都会使读取消息并使其出列</p>
</li>
<li><p>事务：true 每一次messageConsumer.receive()，都可以读取消息，但只有通过session.commit()进行提交，队列中的消息才会出列，否则容易导致消息重复。通过session.rollback()进行回滚。</p>
</li>
</ul>
<h3 id="3-4-3-Acknowledge签收"><a href="#3-4-3-Acknowledge签收" class="headerlink" title="3.4.3 Acknowledge签收"></a>3.4.3 Acknowledge签收</h3><p><strong>参数设置</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//事务与签收</span></span><br><span class="line"><span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> connection.createSession(<span class="literal">false</span>, Session.AUTO_ACKNOWLEDGE);</span><br></pre></td></tr></table></figure>

<p><strong>对于非事务</strong></p>
<ul>
<li><p>自动签收（默认）： Session.AUTO_ACKNOWLEDGE</p>
</li>
<li><p>手动签收：Session.CLIENT_ACKNOWLEDGE 客户端调用acknowledge方法手动签收，否则消息不出列</p>
</li>
<li><p>允许重复消息：Session.DUPS_OK_ACKNOWLEDGE</p>
</li>
</ul>
<p><strong>对于事务</strong></p>
<p>生产事务开启，只有commit后才能将全部消息出列变为已消费。</p>
<p><strong>签收与事务的关系</strong></p>
<p>在事务性会话中，当一个事务被成功提交则消息被自动签收。如果事务回滚，则消息会被再次传送。<br>非事务性会话中，消息何时被确认取决于创建会话时的应答模式（acknowledgement）</p>
<h3 id="3-4-4-集群保证"><a href="#3-4-4-集群保证" class="headerlink" title="3.4.4 集群保证"></a>3.4.4 集群保证</h3><p>详见[9 ActiveMQ的多节点集群](#9 ActiveMQ的多节点集群)</p>
<h2 id="3-5-JMS点对点总结"><a href="#3-5-JMS点对点总结" class="headerlink" title="3.5 JMS点对点总结"></a>3.5 JMS点对点总结</h2><p>点对点模型基于队列。</p>
<p>生产者发送消息到队列，消费者从队列接收消息，队列的存在使得消息的异步传输成为可能。类似于发送短信。</p>
<ul>
<li>如果Session关闭时，部分消息已被读取但是没有签收（acknowledge）或者没有事务处理（commit），那么当消费者下次连接到相同的队列时，消息还能再次接收</li>
<li>队列可以长久地保存消息直到消费者收到消息。消费者不需要因为担心消息会丢失而时刻和队列保持激活的连接状态，充分体现了异步传输模式的优势</li>
</ul>
<h2 id="3-6-JMS订阅发布总结"><a href="#3-6-JMS订阅发布总结" class="headerlink" title="3.6 JMS订阅发布总结"></a>3.6 JMS订阅发布总结</h2><p>JMS Pub&#x2F;Sub 模型定义了如何向一个内容节点发布和订阅消息，这些节点被称作topic</p>
<p>主题可以被认为是消息的传输中介，发布者(publisher)发布消息到主题，订阅者(subscribe)从主题订阅消息。</p>
<p>主题使得消息订阅者和消息发布者保持互相独立，不需要接触即可保证消息的传送。</p>
<ul>
<li>非持久订阅：只有当客户端处于激活状态，或者是和MQ保存会话连接状态，才能收到某个主题的消息。而离线状态时生产者发送的消息，消费者永远无法获取。</li>
<li>持久订阅：首先客户端注册一个身份识别id（connection.setClientID）客户端每一次在线都能接收到离线时生产者发送的主题消息。</li>
</ul>
<h1 id="4-ActiveMQ的Broker"><a href="#4-ActiveMQ的Broker" class="headerlink" title="4 ActiveMQ的Broker"></a>4 ActiveMQ的Broker</h1><h2 id="4-1-Broker"><a href="#4-1-Broker" class="headerlink" title="4.1 Broker"></a>4.1 Broker</h2><p>相当于一个ActiveMQ服务器实例</p>
<p>说白了，Broker其实就是实现了用代码的形式启动ActiveMQ将MQ嵌入到Java代码中，以便随时用随时启动，<br>在用的时候再去启动这样能节省了资源，也保证了可靠性。</p>
<p>不同的配置文件模拟不同的应用场景</p>
<h2 id="4-2-嵌入式Broker"><a href="#4-2-嵌入式Broker" class="headerlink" title="4.2 嵌入式Broker"></a>4.2 嵌入式Broker</h2><p>用ActiveMQ Broker作为独立的消息服务器来构建JAVA应用。<br>ActiveMQ也支持在vm中通信基于嵌入式的broker,I能够无缝的集成其它java应用</p>
<p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmbedBroker</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//ActiveMQ也支持在vm中通信基于嵌入式的broker,I能够无缝的集成其它java应用</span></span><br><span class="line">        <span class="type">BrokerService</span> <span class="variable">brokerService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BrokerService</span>();</span><br><span class="line">        brokerService.setUseJmx(<span class="literal">true</span>);</span><br><span class="line">        brokerService.addConnector(<span class="string">&quot;tcp://localhost:61616&quot;</span>);</span><br><span class="line">        brokerService.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/04/04/ActiveMQ/image-20211228002253638.png" alt="image-20211228002253638"></p>
<p>开启后，通过队列测试成功</p>
<h1 id="5-Spring整合ActiveMQ"><a href="#5-Spring整合ActiveMQ" class="headerlink" title="5 Spring整合ActiveMQ"></a>5 Spring整合ActiveMQ</h1><h2 id="5-1-添加依赖"><a href="#5-1-添加依赖" class="headerlink" title="5.1 添加依赖"></a>5.1 添加依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--        整合Spring和ActiveMQ--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jms<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.23.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        ActiveMQ所需pool包配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.activemq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activemq-pool<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.15.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        Spring相关--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.23.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.23.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-orm<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.23.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjrt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cglib<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cglib<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1_2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-2-配置文件"><a href="#5-2-配置文件" class="headerlink" title="5.2 配置文件"></a>5.2 配置文件</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    开启包扫描--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.tintin.acitvemq.spring&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--    配置生产者--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--池化包装 对于pom中的activemq-pool--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;jmsFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.activemq.pool.PooledConnectionFactory&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;stop&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;connectionFactory&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.activemq.ActiveMQConnectionFactory&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;brokerURL&quot;</span> <span class="attr">value</span>=<span class="string">&quot;tcp://192.168.10.102:61616&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxConnections&quot;</span> <span class="attr">value</span>=<span class="string">&quot;100&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--    配置队列目的地--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;destinationQueue&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.activemq.command.ActiveMQQueue&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span> <span class="attr">value</span>=<span class="string">&quot;spring-active-queue&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    配置主题目的地--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;destinationTopic&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.activemq.command.ActiveMQTopic&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span> <span class="attr">value</span>=<span class="string">&quot;spring-active-topic&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">&lt;!--    JMS工具类 可以进行消息接收和发送--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;jmsTemplate&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jms.core.JmsTemplate&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;connectionFactory&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;jmsFactory&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultDestination&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;destinationQueue&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;messageConverter&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jms.support.converter.SimpleMessageConverter&quot;</span></span></span><br><span class="line"><span class="tag">        &lt;/<span class="attr">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-3-队列实例"><a href="#5-3-队列实例" class="headerlink" title="5.3 队列实例"></a>5.3 队列实例</h2><h3 id="5-3-1-生产者"><a href="#5-3-1-生产者" class="headerlink" title="5.3.1 生产者"></a>5.3.1 生产者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringMQ_Producer</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JmsTemplate jmsTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;classpath:applicationContext.xml&quot;</span>);</span><br><span class="line">        <span class="type">SpringMQ_Producer</span> <span class="variable">springMQ_producer</span> <span class="operator">=</span></span><br><span class="line">                applicationContext.getBean(<span class="string">&quot;springMQ_Producer&quot;</span>,SpringMQ_Producer.class);</span><br><span class="line">        <span class="comment">//发送消息</span></span><br><span class="line">        springMQ_producer.jmsTemplate.send(session -&gt; session.createTextMessage(<span class="string">&quot;Spring和ActiveMQ的整合&quot;</span>)) ;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;send task over&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-2-消费者"><a href="#5-3-2-消费者" class="headerlink" title="5.3.2 消费者"></a>5.3.2 消费者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringMQ_Consumer</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JmsTemplate jmsTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;classpath:applicationContext.xml&quot;</span>);</span><br><span class="line">        <span class="type">SpringMQ_Consumer</span> <span class="variable">SpringMQ_Consumer</span> <span class="operator">=</span></span><br><span class="line">                applicationContext.getBean(<span class="string">&quot;springMQ_Consumer&quot;</span>,SpringMQ_Consumer.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//发送消息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">receivedText</span> <span class="operator">=</span> (String) SpringMQ_Consumer.jmsTemplate.receiveAndConvert();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;receive message &quot;</span>+ receivedText);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-4-主题实例"><a href="#5-4-主题实例" class="headerlink" title="5.4 主题实例"></a>5.4 主题实例</h2><h3 id="5-4-1-生产者"><a href="#5-4-1-生产者" class="headerlink" title="5.4.1 生产者"></a>5.4.1 生产者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTopic</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;classpath:applicationContext.xml&quot;</span>);</span><br><span class="line">    <span class="type">SpringMQ_Producer</span> <span class="variable">springMQ_producer</span> <span class="operator">=</span></span><br><span class="line">            applicationContext.getBean(<span class="string">&quot;springMQ_Producer&quot;</span>,SpringMQ_Producer.class);</span><br><span class="line">    <span class="comment">//发送消息</span></span><br><span class="line">    springMQ_producer.jmsTemplate.send(session -&gt; session.createTextMessage(<span class="string">&quot;Spring和ActiveMQ的整合 for topic&quot;</span>)) ;</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;send task over&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-4-2-消费者"><a href="#5-4-2-消费者" class="headerlink" title="5.4.2 消费者"></a>5.4.2 消费者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTopic</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;classpath:applicationContext.xml&quot;</span>);</span><br><span class="line">    <span class="type">SpringMQ_Consumer</span> <span class="variable">SpringMQ_Consumer</span> <span class="operator">=</span></span><br><span class="line">            applicationContext.getBean(<span class="string">&quot;springMQ_Consumer&quot;</span>,SpringMQ_Consumer.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//接收消息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">receivedText</span> <span class="operator">=</span> (String) SpringMQ_Consumer.jmsTemplate.receiveAndConvert();</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;receive message &quot;</span>+ receivedText);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-4-3-配置监听程序"><a href="#5-4-3-配置监听程序" class="headerlink" title="5.4.3 配置监听程序"></a>5.4.3 配置监听程序</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyMessageListener</span> <span class="keyword">implements</span> <span class="title class_">MessageListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != message &amp;&amp; message <span class="keyword">instanceof</span> TextMessage) &#123;</span><br><span class="line">            <span class="type">TextMessage</span> <span class="variable">textMessage</span> <span class="operator">=</span> (TextMessage) message;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(textMessage.getText());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--    配置监听程序--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;jmsContainer&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jms.listener.DefaultMessageListenerContainer&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;connectionFactory&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;jmsFactory&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;destination&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;destinationQueue&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;messageListener&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;myMessageListener&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/04/04/ActiveMQ/image-20211228194157206.png" alt="image-20211228194157206"></p>
<p>消费者无序启动，监听器直接实例化一个消费者并接收消息</p>
<h1 id="6-SpringBoot整合ActiveMQ"><a href="#6-SpringBoot整合ActiveMQ" class="headerlink" title="6 SpringBoot整合ActiveMQ"></a>6 SpringBoot整合ActiveMQ</h1><h2 id="6-1-添加依赖"><a href="#6-1-添加依赖" class="headerlink" title="6.1  添加依赖"></a>6.1  添加依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-activemq<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="6-2-队列实现"><a href="#6-2-队列实现" class="headerlink" title="6.2 队列实现"></a>6.2 队列实现</h2><h3 id="6-2-1-生产者"><a href="#6-2-1-生产者" class="headerlink" title="6.2.1 生产者"></a>6.2.1 生产者</h3><p>application.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7777</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">activemq:</span></span><br><span class="line">    <span class="attr">broker-url:</span> <span class="string">tcp://192.168.10.102:61616</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line">  <span class="attr">jms:</span></span><br><span class="line">    <span class="attr">pub-sub-domain:</span> <span class="literal">false</span> <span class="comment"># false = queue, true = topic</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自己定义队列名称</span></span><br><span class="line"><span class="attr">myqueue:</span> <span class="string">boot-activemq-queue</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> 配置Bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigBean</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;myqueue&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String myQueue;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ActiveMQQueue</span>(myQueue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@EnableJms</span> <span class="comment">//开启注解</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueueProducer</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JmsMessagingTemplate jmsMessagingTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Queue queue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">produceMsg</span><span class="params">()</span> &#123;</span><br><span class="line">        jmsMessagingTemplate.convertAndSend(queue, UUID.randomUUID().toString().substring(<span class="number">0</span>,<span class="number">6</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BootMqQueueProducerApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(BootMqQueueProducerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试单元</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest(classes = BootMqQueueProducerApplication.class)</span></span><br><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="meta">@WebAppConfiguration</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BootMqQueueProducerApplicationTests</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> QueueProducer queueProducer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testSend</span><span class="params">()</span> &#123;</span><br><span class="line">        queueProducer.produceMsg();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>消息定时投放</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//间隔时间3s 定投</span></span><br><span class="line"><span class="meta">@Scheduled(fixedDelay = 3000)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">produceMsgScheduled</span><span class="params">()</span> &#123;</span><br><span class="line">    jmsMessagingTemplate.convertAndSend(queue, <span class="string">&quot;scheduled &quot;</span> + UUID.randomUUID().toString().substring(<span class="number">0</span>,<span class="number">6</span>));</span><br><span class="line">    System.out.println(<span class="string">&quot;send over ... ok&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-2消费者"><a href="#6-2-2消费者" class="headerlink" title="6.2.2消费者"></a>6.2.2消费者</h3><p>application.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8888</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>消费者直接监听</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueueConsumer</span> &#123;</span><br><span class="line">    <span class="meta">@JmsListener(destination = &quot;$&#123;myqueue&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receive</span><span class="params">(TextMessage textMessage)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者收到消息&quot;</span> + textMessage.getText());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="6-3-主题实现"><a href="#6-3-主题实现" class="headerlink" title="6.3 主题实现"></a>6.3 主题实现</h2><h3 id="6-3-1-生产者"><a href="#6-3-1-生产者" class="headerlink" title="6.3.1 生产者"></a>6.3.1 生产者</h3><p>application.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">6666</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">activemq:</span></span><br><span class="line">    <span class="attr">broker-url:</span> <span class="string">tcp://192.168.10.102:61616</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line">  <span class="attr">jms:</span></span><br><span class="line">    <span class="attr">pub-sub-domain:</span> <span class="literal">true</span> <span class="comment"># false = queue, true = topic</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自己定义主题名称</span></span><br><span class="line"><span class="attr">mytopic:</span> <span class="string">boot-activemq-topic</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>bean配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigBean</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;mytopic&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String mytopic ;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Topic <span class="title function_">topic</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ActiveMQTopic</span>(mytopic);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TopicProducer</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JmsMessagingTemplate jmsMessagingTemplate;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Topic topic;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">produceMsg</span><span class="params">()</span> &#123;</span><br><span class="line">        jmsMessagingTemplate.convertAndSend(topic,<span class="string">&quot;topic &quot;</span> + UUID.randomUUID().toString().substring(<span class="number">0</span>,<span class="number">6</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-2-消费者"><a href="#6-3-2-消费者" class="headerlink" title="6.3.2 消费者"></a>6.3.2 消费者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TopicConsumer</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JmsMessagingTemplate jmsMessagingTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JmsListener(destination = &quot;$&#123;mytopic&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receive</span><span class="params">(TextMessage textMessage)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(textMessage.getText());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="7-ActiveMQ的传输协议"><a href="#7-ActiveMQ的传输协议" class="headerlink" title="7 ActiveMQ的传输协议"></a>7 ActiveMQ的传输协议</h1><blockquote>
<p>如何修改默认的端口？</p>
<p>如何配置生产时使用的链接协议？</p>
</blockquote>
<h2 id="7-1-是什么"><a href="#7-1-是什么" class="headerlink" title="7.1 是什么"></a>7.1 是什么</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop102 conf]<span class="comment"># vim activemq.xml</span></span><br></pre></td></tr></table></figure>

<p>默认消息协议opernwire</p>
<p><img src="/2022/04/04/ActiveMQ/image-20211229183222902.png" alt="image-20211229183222902"></p>
<h2 id="7-2-常见消息协议"><a href="#7-2-常见消息协议" class="headerlink" title="7.2 常见消息协议"></a>7.2 常见消息协议</h2><h3 id="7-2-1-默认TCP"><a href="#7-2-1-默认TCP" class="headerlink" title="7.2.1 默认TCP"></a>7.2.1 默认TCP</h3><p>在网络传输数据前，必须要序列化数据，消息是通过一个叫wire protocol的来序列化成字节流。<br>默认情况下ActiveMQ把wire protocol叫做OpenWire,它的目的是促使网络上的效率和数据快速交互。</p>
<p>TCP传输的优点：<br>TCP协议传输可靠性高，稳定性强工<br>高效性：字节流方式传递，效率很高<br>有效性、可用性：：应用广泛，支持任何平台</p>
<h3 id="7-2-2-NIO-（New-I-x2F-O-API）"><a href="#7-2-2-NIO-（New-I-x2F-O-API）" class="headerlink" title="7.2.2 NIO （New I&#x2F;O API）"></a>7.2.2 NIO （New I&#x2F;O API）</h3><ol>
<li>NIO协议和TCP协议类似但NIO更侧重于底层的访问操作。它允许开发人员对同一资源可有更多的client调用和服务端有更多的负<br>载。</li>
<li>适合使用NIO协议的场景：<ol>
<li>可能有大量的Client去连接到Broker上，一般情况下，大量的Client去连接Broker是被操作系统的线程所限<br>因此，NIO的实现比TCP需要更少的线程去运行，所以建议使用NIO协议</li>
<li>可能对于Broker有一个很迟钝的网络传输，<strong>NIO比TCP提供更好的性能。</strong></li>
</ol>
</li>
</ol>
<h3 id="7-2-3-其他协议"><a href="#7-2-3-其他协议" class="headerlink" title="7.2.3 其他协议"></a>7.2.3 其他协议</h3><p>AMQP协议 即Advanced Message Queuing Protocol,一个提供统一消息服务的应用层标准高级队列应用层协议的一个开放标准,为面向消息的中间件设计。基于此协议的客户端与消息中间件可传递消息，并不受客户端&#x2F;中间件不同产品，不同开发语言等条件的限制。</p>
<p>stomp协议 STOMP,streamingTextOrientatedMessageProtocol，是一种为MOM(Message Oriented Middleware，面向消息的中间件)设计的简单文本协议。</p>
<p>SSL协议（Secure Socket Layer Protocol）</p>
<p>mqtt协议 （Message Queuing Telemetry Transport，消息队列遥测传输）是IBM开发的一个即时通讯协议，有可能成为物联网<br>要组成部分。该协议支持所有平台，几乎可以把所有联网物品和外部连接起来，被用来当做传感器和致动器（比如通过Twitter让房屋联网）的通信协议。</p>
<p>ws协议 （web socket protocol）</p>
<h3 id="7-2-4-小结"><a href="#7-2-4-小结" class="headerlink" title="7.2.4 小结"></a>7.2.4 小结</h3><table>
<thead>
<tr>
<th>协议</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>TCP</td>
<td>默认协议，性能相对不错</td>
</tr>
<tr>
<td>NIO</td>
<td>基于TCP协议之上，拓展优化，具有更好的拓展性</td>
</tr>
<tr>
<td>UDP</td>
<td>性能比TCP好，但不具有可靠性</td>
</tr>
<tr>
<td>SSL</td>
<td>安全链接</td>
</tr>
<tr>
<td>HTTP(S)</td>
<td>基于HTTP或HTTPS</td>
</tr>
<tr>
<td>VM</td>
<td>VM本身不是协议，当客户端和代理在同一个Java虚拟机(VM)中运行时,他们之间需要通信,但不想占用网络通道，而是直接通信，可以使用该方式</td>
</tr>
</tbody></table>
<h2 id="7-3-NIO传输案例演示"><a href="#7-3-NIO传输案例演示" class="headerlink" title="7.3 NIO传输案例演示"></a>7.3 NIO传输案例演示</h2><p>如果您不特别指定ActiveMQ的网络监听端口，那么这些端口都将使用BIO网络IO模型。（OpenWire, STOMP, AMQP<br>所以为了首先提高单节点的网络吞吐性能，我们需要明确指定Active的网络IO模型，</p>
<p>如下图，uri以nio开头表示使用以tcp协议为基础的NIO网络IO模型</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">transportConnector</span> <span class="attr">name</span>=<span class="string">&quot;nio&quot;</span> <span class="attr">uri</span>=<span class="string">&quot;nio://0.0.0.0:61618?trace=true&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/04/04/ActiveMQ/image-20211229192338872.png" alt="image-20211229192338872"></p>
<h2 id="7-4-NIO传输案例演示增强"><a href="#7-4-NIO传输案例演示增强" class="headerlink" title="7.4 NIO传输案例演示增强"></a>7.4 NIO传输案例演示增强</h2><blockquote>
<p>上述NIO性能不错了，如何进一步优化？</p>
<p>URI格式头以”nio”开头，表示这个端口使用以TCP协议为基础的NIO网络IO模型。但是这样的设置方式，只能使这个端口支持Openwire协议。</p>
<p>那么我们怎么既让这个端口支持Nlo网络lo模型，又让它支持多个协议呢？</p>
</blockquote>
<p>使用auto关键字<br>解决<br>使用“+”符号来为端口设置多种特性<br>如果我们既需要某一个端口支持NIO网络IO模型，又需要它支持多个协议<img src="/2022/04/04/ActiveMQ/image-20211229224135978.png" alt="image-20211229224135978"></p>
<p><img src="/2022/04/04/ActiveMQ/image-20211229224057758.png" alt="image-20211229224057758"></p>
<h1 id="8-ActiveMQ消息存储与持久化"><a href="#8-ActiveMQ消息存储与持久化" class="headerlink" title="8 ActiveMQ消息存储与持久化"></a>8 ActiveMQ消息存储与持久化</h1><h2 id="8-1-简介"><a href="#8-1-简介" class="headerlink" title="8.1 简介"></a>8.1 简介</h2><p>保证MQ服务器宕机后，消息不会丢失</p>
<p>为了避免意外宕机以后丢失信息，需要做到重启后可以恢复消息队列，消息系统一般都会采用<strong>持久化机制。</strong></p>
<p>ActiveMQ的消息持久化机制有JDBC，AMQ，KahaDB和LevelDB，无论使用哪种持久化方式，消息的存储逻辑都是一致的。就是在发送者将消息发送出去后，消息中心首先将消息存储到本地数据文件、内存数据库或者远程数据库等再试图将消息发送给接收者，成功则将消息从存储中删除，失败则继续尝试发送。</p>
<p>消息中心启动以后首先要检查指定的存储位置，如果有未发送成功的消息，则需要把消息发送出去。</p>
<h2 id="8-2-存储方式"><a href="#8-2-存储方式" class="headerlink" title="8.2 存储方式"></a>8.2 存储方式</h2><h3 id="8-2-1-AMQ-Message-Store-了解"><a href="#8-2-1-AMQ-Message-Store-了解" class="headerlink" title="8.2.1 AMQ Message Store(了解)"></a>8.2.1 AMQ Message Store(了解)</h3><p>文件存储形式，写入速度快、易恢复。文件默认大小32M。当存储文件的所有消息都被消费，该文件被标识为可删除。适用于ActiveMQ 5.3前 </p>
<h3 id="8-2-2-KahaDB消息存储-默认"><a href="#8-2-2-KahaDB消息存储-默认" class="headerlink" title="8.2.2 KahaDB消息存储(默认)"></a>8.2.2 KahaDB消息存储(默认)</h3><p>基于日志文件，从ActiveMQ5.4开始默认的持久化插件</p>
<p>activemq.xml中的配置</p>
<p><img src="/2022/04/04/ActiveMQ/image-20211230035948183.png" alt="image-20211230035948183"></p>
<p>消息存储使用一个<strong>事务日志（b-<Number>.log）</Number></strong>和仅仅用一个<strong>索引文件（db.data）</strong>来存储它所有的地址。<br>KahaDB是一个专门针对消息持久化的解决方案,它对典型的消息使用模式进行了优化。<br>数据被追加到data logs中。当不再需要log文件中的数据的时候,log文件会被丢弃</p>
<p>存储原理</p>
<p><img src="/2022/04/04/ActiveMQ/image-20211230133810680.png" alt="image-20211230133810680"></p>
<ul>
<li>db-<Number>.log KahaDB存储消息到预定义大小的数据记录文件中，文件命名为db-<Number>.log。。当数据文件已满时，一个新的文件会随之创建，number数值也会随之递增，它随着消息数量的增多，如每32M一个文件，文件名按照数字进行编号，如db-1.log、db-2.log、db-3.log …。当不再有引用到数据文件中的任何消息时，文件会被<strong>删除或归档</strong>。</Number></Number></li>
<li>db.data该文件包含了持久化的BTree索引，索引了消息数据记录中的消息,它是消息的索引文件，本质上是B-Tree（B树），使用B-Tree作为索引指向db-<Number>.log里面存储的消息。</Number></li>
<li>db.free 记录当前db.data文件里哪些页面是空闲的，文件具体内容是所有空闲页的ID</li>
<li>db.redo 用来进行消息恢复,如果KahaDB消息存储在强制退出后启动用于恢复BTree索引。</li>
<li>lock文件锁，表示当前获得kahadb读写权限的broker。</li>
</ul>
<h3 id="8-2-3-JDBC消息存储"><a href="#8-2-3-JDBC消息存储" class="headerlink" title="8.2.3 JDBC消息存储"></a>8.2.3 JDBC消息存储</h3><p><img src="/2022/04/04/ActiveMQ/image-20211230151943446.png" alt="image-20211230151943446"></p>
<p>消息存储于数据库中</p>
<h3 id="8-2-4-LevelDB消息存储（了解）"><a href="#8-2-4-LevelDB消息存储（了解）" class="headerlink" title="8.2.4 LevelDB消息存储（了解）"></a>8.2.4 LevelDB消息存储（了解）</h3><p>这种文件系统是从ActiveMQ5.8之后引进的，它和KahaDB非常相似，也是<strong>基于文件</strong>的本地数据库储存形式，但是它提供比KahaDB更快的<strong>持久性</strong>。但它不使用自定义B-Tree实现来索引预写日志，而是使用基于LevelDB的索引</p>
<h3 id="8-2-5-JDBC-Message-store-with-ActiveMQ-Journal"><a href="#8-2-5-JDBC-Message-store-with-ActiveMQ-Journal" class="headerlink" title="8.2.5 JDBC Message store with ActiveMQ Journal"></a>8.2.5 JDBC Message store with ActiveMQ Journal</h3><h2 id="8-3-JDBC消息存储"><a href="#8-3-JDBC消息存储" class="headerlink" title="8.3 JDBC消息存储"></a>8.3 JDBC消息存储</h2><h3 id="8-3-1-lib文件夹中添加数据库驱动jar包"><a href="#8-3-1-lib文件夹中添加数据库驱动jar包" class="headerlink" title="8.3.1 lib文件夹中添加数据库驱动jar包"></a>8.3.1 lib文件夹中添加数据库驱动jar包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop102 module]<span class="comment"># mv mysql-connector-java-5.1.38/mysql-connector-java-5.1.38-bin.jar activemq-5.16.3/lib/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="8-3-2-修改activemq-xml的持久化配置"><a href="#8-3-2-修改activemq-xml的持久化配置" class="headerlink" title="8.3.2 修改activemq.xml的持久化配置"></a>8.3.2 修改activemq.xml的持久化配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;kahaDB directory=&quot;$&#123;activemq.data&#125;/kahadb&quot;/&gt; 原先的配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdbcPersistenceAdapter</span> <span class="attr">dataSource</span>=<span class="string">&quot;#mysql-ds&quot;</span> <span class="attr">createTablesOnStartup</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>dataSource指定将要引用的持久化数据库的bean名称，createTablesOnStartup是否在启动的时候创建数据表，默认值是true，<br>这样每次启动都会去创建数据表了，一般是第一次启动的时候设置为true之后改成false。</p>
<h3 id="8-3-3-数据源配置"><a href="#8-3-3-数据源配置" class="headerlink" title="8.3.3 数据源配置"></a>8.3.3 数据源配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;mysql-ds&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.commons.dbcp2.BasicDataSource&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://192.168.137.1:3306/activemq?relaxAutoCommit=true<span class="symbol">&amp;amp;</span>useSSL=false<span class="symbol">&amp;amp;</span>serverTimezone=GMT%2B8<span class="symbol">&amp;amp;</span>allowPublicKeyRetrieval=true&quot;</span>/&gt;</span></span><br><span class="line">         <span class="comment">&lt;!--XML必须使用转译字符,而且还要加上serverTimezone和useSSL--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;tintin&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxTotal&quot;</span> <span class="attr">value</span>=<span class="string">&quot;200&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;poolPreparedStatements&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="8-3-4-MySQL授予远程连接的权限"><a href="#8-3-4-MySQL授予远程连接的权限" class="headerlink" title="8.3.4 MySQL授予远程连接的权限"></a>8.3.4 MySQL授予远程连接的权限</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">USE mysql;</span><br><span class="line"><span class="keyword">SELECT</span> HOST,<span class="keyword">USER</span> <span class="keyword">FROM</span> <span class="keyword">USER</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">USER</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;192.168.10.102&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;tintin&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;192.168.10.102&#x27;</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> OPTION</span><br><span class="line">FLUSH PRIVILEGES; # 刷新权限</span><br></pre></td></tr></table></figure>

<p><a href="%E6%9D%82%E8%AE%B0.md#MySQL%E6%8E%88%E4%BA%88%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5%E7%9A%84%E6%9D%83%E9%99%90">MySQL授予远程连接的权限</a></p>
<h3 id="8-3-5-创建数据库并自动生成表"><a href="#8-3-5-创建数据库并自动生成表" class="headerlink" title="8.3.5 创建数据库并自动生成表"></a>8.3.5 创建数据库并自动生成表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">createa DATABASE activemq;</span><br></pre></td></tr></table></figure>

<table>    
    <tr><td colspan="2" align="center">ACTIVEMQ_MSGS表</td></tr>     
    <tr><td>字段</td><td>描述</td></tr>
    <tr><td>ID</td><td>自增的数据库主键</td></tr>
    <tr><td>CONTAINER</td><td>消息的Destination</td></tr>
    <tr><td>MSGID_PROD</td><td>消息发送者的主键</td></tr>
    <tr><td>MSG_SEQ</td><td>是发送消息的顺序，MSGID_PROD+MSG_SEQ可以组成JMS的MessagelD</td></tr>
    <tr><td>EXPIRATION</td><td>消息的过期时间，存储的是从1970-01-01到现在的毫秒数</td></tr>
    <tr><td>MSG</td><td>消息本体的Java序列化对象的二进制数据</td></tr>
    <tr><td>PRIORITY</td><td>优先级，从0-9，数值越大优先级越高</td></tr>
<table>


<table>    
    <tr><td colspan="2" align="center">ACTIVEMQ_ACKS表</td></tr> 
    <tr><td colspan="2">用于存储订阅关系。如果是持久化Topic，订阅者和服务器的订阅关系在这个表保存。</td></tr>
    <tr><td>字段</td><td>描述</td></tr>
    <tr><td>CONTAINER</td><td>消息的Destination</td></tr>
    <tr><td>SUB_DEST</td><td>如果是使用Static集群，这个字段会有集群其他系统的信息</td></tr>
    <tr><td>CLIENT_ID</td><td>每个订阅者都必须有一个唯一的客户端ID用以区分</td></tr>
    <tr><td>SUB_NAME</td><td>订阅者名称</td></tr>
    <tr><td>SELECTOR</td><td>选择器，可以选择只消费满足条件的消息。条件可以用自定义属性实现，可支持多属性AND和OR操作</td></tr>
    <tr><td>LAST_ACKED_ID</td><td>记录消费过的消息的ID。</td></tr>
<table>
<table>    
    <tr><td align="center">ACTIVEMQ_LOCK表</td></tr>     
    <tr><td>表activemq_lock在集群环境中才有用，只有一个Broker可以获得消息，称为Master Broker，其他的只能作为备份等待Master
Broker不可用，才可能成为下一个Master Broker。这个表用于记录哪个Broker是当前的Master Broker。</td></tr>
<table>


<h3 id="8-3-6-代码验证以及数据库情况"><a href="#8-3-6-代码验证以及数据库情况" class="headerlink" title="8.3.6 代码验证以及数据库情况"></a>8.3.6 代码验证以及数据库情况</h3><p>在点对点类型中<br>当DeliveryMode设置为NON_PERSISTENCE时，消息被保存在内存中；<br>当DeliveryMode设置为PERSISTENCE时，消息保存在broker的相应的文件或者数据库中。<br>而且点对点类型中消息一旦被Consumer消费就从broker中删除。</p>
<p><img src="/2022/04/04/ActiveMQ/image-20211230203911552.png" alt="image-20211230203911552"></p>
<p><img src="/2022/04/04/ActiveMQ/image-20211230203923363.png" alt="image-20211230203923363"></p>
<p>在发布订阅类型中</p>
<p>订阅者和服务器的订阅关系在ACTIVEMQ_ACKS表保存。</p>
<p><img src="/2022/04/04/ActiveMQ/image-20211230210844650.png" alt="image-20211230210844650"></p>
<h3 id="8-3-7-填坑"><a href="#8-3-7-填坑" class="headerlink" title="8.3.7 填坑"></a>8.3.7 填坑</h3><p>数据库jar包<br>记得需要使用到的相关jar文件放置到ActiveMQ安装路径下的lib目录。mysqI-jdbc驱动的jar包和对应的数据库连接池jar包<br>createTablesOnStartup属性</p>
<p>在jdbcPersistenceAdapter标签中设置了createTablesOnStartup属性为true时在第一次启动ActiveMQ时，ActiveMQ服务节点会自动创建所需要的数据表。启动完成后可以去掉这个属性，或者更改createTablesOnStartup属性为false。</p>
<p>下滑线坑爹<br>“java.lang.lllegalStateException:BeanFactory not initialized or already closed”这是因为您的操作系统的机器名中有“_”符号。请更改机器名并且重启后即可解决问题。</p>
<h2 id="8-4-JDBC-Message-store-with-ActiveMQ-Journal"><a href="#8-4-JDBC-Message-store-with-ActiveMQ-Journal" class="headerlink" title="8.4 JDBC Message store with ActiveMQ Journal"></a>8.4 JDBC Message store with ActiveMQ Journal</h2><p>这种方式克服了JDBC Store的不足，JDBC每次消息过来，都需要去写库和读库。<br>ActiveMQ Journal，使用高速缓存写入技术，大大提高了性能。<br>当<strong>消费者的消费速度能够及时跟上生产者消息的生产速度</strong>时，journal文件能够大大减少需要写入到DB中的消息。</p>
<p>配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">persistenceFactory</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">journalPersistenceAdapterFactory</span> </span></span><br><span class="line"><span class="tag">                 <span class="attr">journalLogFiles</span>=<span class="string">&quot;4&quot;</span></span></span><br><span class="line"><span class="tag">                 <span class="attr">journalLogFileSize</span>=<span class="string">&quot;32768&quot;</span></span></span><br><span class="line"><span class="tag">                 <span class="attr">useJournal</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">                 <span class="attr">useQuickJournal</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">                 <span class="attr">dataSource</span>=<span class="string">&quot;#mysql-ds&quot;</span></span></span><br><span class="line"><span class="tag">                 <span class="attr">dataDirectory</span>=<span class="string">&quot;activemq-data&quot;</span>/&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">persistenceFactory</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line"> <span class="comment">&lt;!--&lt;persistenceAdapter&gt;--&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--&lt;kahaDB directory=&quot;$&#123;activemq.data&#125;/kahadb&quot;/&gt; 原先的配置--&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--&lt;jdbcPersistenceAdapter dataSource=&quot;#mysql-ds&quot; createTablesOnStartup=&quot;false&quot;/&gt;</span></span><br><span class="line"><span class="comment"> &lt;/persistenceAdapter&gt;--&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="8-5-持久化机制总结"><a href="#8-5-持久化机制总结" class="headerlink" title="8.5 持久化机制总结"></a>8.5 持久化机制总结</h2><p><img src="/2022/04/04/ActiveMQ/image-20211230214753485.png" alt="image-20211230214753485"></p>
<h1 id="9-ActiveMQ的多节点集群"><a href="#9-ActiveMQ的多节点集群" class="headerlink" title="9 ActiveMQ的多节点集群"></a>9 ActiveMQ的多节点集群</h1><p>基于ZooKeeper和LevelDB搭建ActiveMQ集群。</p>
<p>集群仅提供主备方式的高可用集群功能， 避免单点故障。<br>.</p>
<h2 id="9-1-三种集群方式"><a href="#9-1-三种集群方式" class="headerlink" title="9.1 三种集群方式"></a>9.1 三种集群方式</h2><p>基于sharedFileSystem共享文件系统</p>
<p><img src="/2022/04/04/ActiveMQ/image-20211231135735442.png" alt="image-20211231135735442"></p>
<p>基于JDBC</p>
<p>基于Replicated Level DB</p>
<p><img src="/2022/04/04/ActiveMQ/image-20211231140136788.png" alt="image-20211231140136788"></p>
<p>已弃用</p>
<h2 id="9-2-基于Replicated-Level-DB集群配置部署"><a href="#9-2-基于Replicated-Level-DB集群配置部署" class="headerlink" title="9.2 基于Replicated Level DB集群配置部署"></a>9.2 基于Replicated Level DB集群配置部署</h2><h3 id="9-2-1-环境"><a href="#9-2-1-环境" class="headerlink" title="9.2.1 环境"></a>9.2.1 环境</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop102 module]<span class="comment"># cat /etc/redhat-release</span></span><br><span class="line">CentOS Linux release 7.5.1804 (Core) </span><br></pre></td></tr></table></figure>

<p>activemq-5.16.3  </p>
<p>jdk1.8.0_311  </p>
<p>zookeeper-3.5.7</p>
<h3 id="9-2-2-单机部署规划"><a href="#9-2-2-单机部署规划" class="headerlink" title="9.2.2 单机部署规划"></a>9.2.2 单机部署规划</h3><p><img src="/2022/04/04/ActiveMQ/image-20211231141647433.png" alt="image-20211231141647433"></p>
<h3 id="9-2-3-配置zk集群"><a href="#9-2-3-配置zk集群" class="headerlink" title="9.2.3 配置zk集群"></a>9.2.3 配置zk集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop102 mq_cluster]<span class="comment"># mkdir /zk_culster/</span></span><br><span class="line">[root@hadoop102 zk_cluster]<span class="comment"># cp -r /opt/module/zookeeper-3.5.7/ zk_node01</span></span><br><span class="line">[root@hadoop102 zk_cluster]<span class="comment"># cp -r /opt/module/zookeeper-3.5.7/ zk_node02</span></span><br><span class="line">[root@hadoop102 zk_cluster]<span class="comment"># cp -r /opt/module/zookeeper-3.5.7/ zk_node03</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># zoo.cfg</span></span><br><span class="line">dataDir=/zk_cluster/zk_node01/zkData</span><br><span class="line">clientPort=<span class="number">2191</span></span><br><span class="line"><span class="meta"># server.几号服务器=服务器地址:follower与leader交换信息的端口：挂掉后选举新leader后的端口 </span></span><br><span class="line">#################<span class="meta">#cluster########################</span></span><br><span class="line">server<span class="number">.1</span>=hadoop102:<span class="number">2881</span>:<span class="number">3881</span></span><br><span class="line">server<span class="number">.2</span>=hadoop102:<span class="number">2882</span>:<span class="number">3882</span></span><br><span class="line">server<span class="number">.3</span>=hadoop102:<span class="number">2883</span>:<span class="number">3883</span>                             </span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop102 zk_culster]<span class="comment"># echo 1 &gt; zk_node01/zkData/myid</span></span><br><span class="line">[root@hadoop102 zk_culster]<span class="comment"># echo 2 &gt; zk_node02/zkData/myid</span></span><br><span class="line">[root@hadoop102 zk_culster]<span class="comment"># echo 3 &gt; zk_node03/zkData/myid</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="9-2-4-创建mq集群目录"><a href="#9-2-4-创建mq集群目录" class="headerlink" title="9.2.4 创建mq集群目录"></a>9.2.4 创建mq集群目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop102 module]<span class="comment"># mkdir /mq_cluster/</span></span><br><span class="line">[root@hadoop102 module]<span class="comment"># cd /mq_cluster/</span></span><br><span class="line">[root@hadoop102 mq_cluster]<span class="comment"># cp -r /opt/module/activemq-5.16.3/ mq_node01</span></span><br><span class="line">[root@hadoop102 mq_cluster]<span class="comment"># cp -r mq_node01 mq_node02</span></span><br><span class="line">[root@hadoop102 mq_cluster]<span class="comment"># cp -r mq_node01 mq_node03</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="9-2-5-修改管理前台的端口"><a href="#9-2-5-修改管理前台的端口" class="headerlink" title="9.2.5 修改管理前台的端口"></a>9.2.5 修改管理前台的端口</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--jetty.xml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;port&quot;</span> <span class="attr">value</span>=<span class="string">&quot;8162&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="9-2-6-集群配置"><a href="#9-2-6-集群配置" class="headerlink" title="9.2.6 集群配置"></a>9.2.6 集群配置</h3><p>brokerName一致</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop102 mq_cluster]<span class="comment"># vim mq_node01/conf/activemq.xml</span></span><br><span class="line">[root@hadoop102 mq_cluster]<span class="comment"># vim mq_node02/conf/activemq.xml</span></span><br><span class="line">[root@hadoop102 mq_cluster]<span class="comment"># vim mq_node03/conf/activemq.xml</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--修改为本机对应域名 而不是localhost--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">broker</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://activemq.apache.org/schema/core&quot;</span> <span class="attr">brokerName</span>=<span class="string">&quot;hadoop102&quot;</span> <span class="attr">dataDirectory</span>=<span class="string">&quot;$&#123;activemq.data&#125;&quot;</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>持久化配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">replicatedLevelDB</span></span></span><br><span class="line"><span class="tag">                <span class="attr">directory</span>=<span class="string">&quot;$&#123;activemq.data&#125;/leveldb&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">replicas</span>=<span class="string">&quot;3&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">bind</span>=<span class="string">&quot;tcp://0.0.0.0:63631&quot;</span> &lt;!<span class="attr">--63631</span> <span class="attr">63631--</span>&gt;</span></span><br><span class="line">                zkAddress=&quot;hadoop102:2191,hadoop102:2192,hadoop102:2193&quot;</span><br><span class="line">                sync=&quot;local_disk&quot;</span><br><span class="line">                zkPath=&quot;/activemq/leveldb-stores&quot;</span><br><span class="line">                hostname=&quot;hadoop102&quot;</span><br><span class="line">        /&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="9-2-7-修改消息端口"><a href="#9-2-7-修改消息端口" class="headerlink" title="9.2.7 修改消息端口"></a>9.2.7 修改消息端口</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">transportConnector</span> <span class="attr">name</span>=<span class="string">&quot;openwire&quot;</span> <span class="attr">uri</span>=<span class="string">&quot;tcp://0.0.0.0:61618?maximumConnections=1000<span class="symbol">&amp;amp;</span>wireFormat.maxFrameSize=104857600&quot;</span>/&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="9-2-8-启动zk集群后启动mq集群"><a href="#9-2-8-启动zk集群后启动mq集群" class="headerlink" title="9.2.8 启动zk集群后启动mq集群"></a>9.2.8 启动zk集群后启动mq集群</h3><p><img src="/2022/04/04/ActiveMQ/image-20211231155350713.png" alt="image-20211231155350713"></p>
<p>查看zk状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop102 zk_cluster]<span class="comment"># zk_node01/bin/zkCli.sh -server hadoop102:2191</span></span><br><span class="line"></span><br><span class="line">[zk: hadoop102:2191(CONNECTED) 1] <span class="built_in">ls</span> /</span><br><span class="line">[activemq, zookeeper]</span><br><span class="line">[zk: hadoop102:2191(CONNECTED) 2] <span class="built_in">ls</span> /activemq</span><br><span class="line">[leveldb-stores]</span><br><span class="line">[zk: hadoop102:2191(CONNECTED) 3] <span class="built_in">ls</span> /activemq/leveldb-stores</span><br><span class="line">[00000000000, 00000000001, 00000000003]</span><br><span class="line">[zk: hadoop102:2191(CONNECTED) 5] get /activemq/leveldb-stores/00000000000</span><br><span class="line">&#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;hadoop102&quot;</span>,<span class="string">&quot;container&quot;</span>:null,<span class="string">&quot;address&quot;</span>:<span class="string">&quot;tcp://hadoop102:63631&quot;</span>,<span class="string">&quot;position&quot;</span>:-1,<span class="string">&quot;weight&quot;</span>:1,<span class="string">&quot;elected&quot;</span>:<span class="string">&quot;0000000000&quot;</span>&#125;</span><br><span class="line">[zk: hadoop102:2191(CONNECTED) 6] get /activemq/leveldb-stores/00000000001</span><br><span class="line">&#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;hadoop102&quot;</span>,<span class="string">&quot;container&quot;</span>:null,<span class="string">&quot;address&quot;</span>:null,<span class="string">&quot;position&quot;</span>:-1,<span class="string">&quot;weight&quot;</span>:1,<span class="string">&quot;elected&quot;</span>:null&#125;</span><br><span class="line">[zk: hadoop102:2191(CONNECTED) 8] get /activemq/leveldb-stores/00000000003</span><br><span class="line">&#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;hadoop102&quot;</span>,<span class="string">&quot;container&quot;</span>:null,<span class="string">&quot;address&quot;</span>:null,<span class="string">&quot;position&quot;</span>:-1,<span class="string">&quot;weight&quot;</span>:1,<span class="string">&quot;elected&quot;</span>:null&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>mq集群挂载zk成功</p>
<p>查看mq状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop102 zk_cluster]<span class="comment"># ps -ef| grep activemq| grep -v grep</span></span><br><span class="line">root       2776      1  2 15:50 pts/0    00:00:27 /opt/module/jdk1.8.0_311/bin/java -Xms64M -Xmx1G -Djava.util.logging.config.file=logging.properties -Djava.security.auth.login.config=/mq_cluster/mq_node01//conf/login.config -Dcom.sun.management.jmxremote -Djava.awt.headless=<span class="literal">true</span> -Djava.io.tmpdir=/mq_cluster/mq_node01//tmp -Dactivemq.classpath=/mq_cluster/mq_node01//conf:/mq_cluster/mq_node01//../lib/: -Dactivemq.home=/mq_cluster/mq_node01/ -Dactivemq.base=/mq_cluster/mq_node01/ -Dactivemq.conf=/mq_cluster/mq_node01//conf -Dactivemq.data=/mq_cluster/mq_node01//data -jar /mq_cluster/mq_node01//bin/activemq.jar start</span><br><span class="line">root       2863      1  1 15:50 pts/0    00:00:13 /opt/module/jdk1.8.0_311/bin/java -Xms64M -Xmx1G -Djava.util.logging.config.file=logging.properties -Djava.security.auth.login.config=/mq_cluster/mq_node02//conf/login.config -Dcom.sun.management.jmxremote -Djava.awt.headless=<span class="literal">true</span> -Djava.io.tmpdir=/mq_cluster/mq_node02//tmp -Dactivemq.classpath=/mq_cluster/mq_node02//conf:/mq_cluster/mq_node02//../lib/: -Dactivemq.home=/mq_cluster/mq_node02/ -Dactivemq.base=/mq_cluster/mq_node02/ -Dactivemq.conf=/mq_cluster/mq_node02//conf -Dactivemq.data=/mq_cluster/mq_node02//data -jar /mq_cluster/mq_node02//bin/activemq.jar start</span><br><span class="line">root       3394      1  1 15:53 pts/0    00:00:09 /opt/module/jdk1.8.0_311/bin/java -Xms64M -Xmx1G -Djava.util.logging.config.file=logging.properties -Djava.security.auth.login.config=/mq_cluster/mq_node03//conf/login.config -Dcom.sun.management.jmxremote -Djava.awt.headless=<span class="literal">true</span> -Djava.io.tmpdir=/mq_cluster/mq_node03//tmp -Dactivemq.classpath=/mq_cluster/mq_node03//conf:/mq_cluster/mq_node03//../lib/: -Dactivemq.home=/mq_cluster/mq_node03/ -Dactivemq.base=/mq_cluster/mq_node03/ -Dactivemq.conf=/mq_cluster/mq_node03//conf -Dactivemq.data=/mq_cluster/mq_node03//data -jar /mq_cluster/mq_node03//bin/activemq.jar start</span><br><span class="line"></span><br><span class="line">[root@hadoop102 zk_cluster]<span class="comment"># netstat -anp |grep 8161</span></span><br><span class="line">tcp6       0      0 :::8161                 :::*                    LISTEN      2776/java           </span><br><span class="line">[root@hadoop102 zk_cluster]<span class="comment"># netstat -anp |grep 8162</span></span><br><span class="line">[root@hadoop102 zk_cluster]<span class="comment"># netstat -anp |grep 8163</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>仅一个端口正在运行能被访问</p>
<h2 id="9-3-集群可用性测试"><a href="#9-3-集群可用性测试" class="headerlink" title="9.3 集群可用性测试"></a>9.3 集群可用性测试</h2><p>ActiveMQ的客户端只能访问Master的Broker,其他处于Slave的Broker不能访问，所以客户端连接的Broker应该使用failover协议(失败转移)</p>
<p>当一个ActiveMQ节点挂掉或者一个Zookeeper节点挂掉，ActiveMQ服务依然正常运转，如果仅剩一个ActiveMQ节点,由于不能选举Master，所以ActiveMQ不能正常运行；</p>
<p>同样的,如果Zookeeper仅剩一个节点活动，不管ActiveMQ各节点存活，ActiveMQ也不能正常提供服务。(ActiveMQ集群的高<br>可用，依赖于Zookeeper集群的高可用）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ACTIVEMQ_URL_CLUSTER</span> <span class="operator">=</span> <span class="string">&quot;failover:(tcp://192.168.10.102:61616,tcp://192.168.10.102:61617,tcp://192.168.10.102:61618)?randomize=false&quot;</span>;<span class="comment">//失败转移协议的访问url</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME_CLUSTER</span> <span class="operator">=</span> <span class="string">&quot;queue1&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>干掉master端口 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop102 mq_node02]<span class="comment"># kill -9 2776</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="10-高级特性与面试"><a href="#10-高级特性与面试" class="headerlink" title="10 高级特性与面试"></a>10 高级特性与面试</h1><h2 id="10-1-异步投递"><a href="#10-1-异步投递" class="headerlink" title="10.1 异步投递"></a>10.1 异步投递</h2><p>ActiveMQ支持同步、异步两种发送的模式将消息发送到broker,模式的选择对发送更(产出率&#x3D;发送数据总量&#x2F;时间)主要受发送延时的影响，使用异步发送可以显著的提高发送的性能。</p>
<p>ActiveMQ默认使用异步发送的模式：除非明确指定使用同步发送的方式或者在未使用事务的前提下发送持久化的消息，这两种情况<br>都是同步发送的。</p>
<p><strong>同步发送</strong></p>
<p>如果你没有使用事务且发送的是持久化的消息，每一次发送都是同步发送的且会阻塞producer直到broker返回一个确认，表示消息已<br>经被安全的持久化到磁盘。确认机制提供了消息安全的保障，但同时会阻塞客户端带来了很大的延时。</p>
<p><strong>异步发送</strong></p>
<p>很多高性能的应用，允许在失败的情况下有少量的数据丢失。如果你的应用满足这个特点，你可以使用异步发送来提高生产率，即使<br>发送的是持久化的消息。</p>
<p>它可以最大化produer端的发送效率。我们通常在发送消息量比较密集的情况下使用异步发送，它可以很大的提升Producer性能；<br>不过这也带来了额外的问题，就是需要消耗较多的Client端内存同时也会导致broker端性能消耗增加；此外它不能有效的确保消息的发送成功。在useAsyncSend&#x3D;true的情况下客户端需要容忍消息丢失的可能。</p>
<p><strong>测试</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">        activeMQConnectionFactory.setUseAsyncSend(<span class="literal">true</span>);<span class="comment">//开启异步投递</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="comment">//异步投递，成功后将执行消息回调函数</span></span><br><span class="line">            textMessage = session.createTextMessage(<span class="string">&quot;msg&quot;</span> + (i + <span class="number">1</span>));</span><br><span class="line">            textMessage.setJMSMessageID(UUID.randomUUID().toString().substring(<span class="number">0</span>,<span class="number">6</span>) + <span class="string">&quot;---tintin&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">msgID</span> <span class="operator">=</span> textMessage.getJMSMessageID();</span><br><span class="line">            messageProducer.send(textMessage, <span class="keyword">new</span> <span class="title class_">AsyncCallback</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">()</span> &#123;</span><br><span class="line">                    System.out.println(msgID + <span class="string">&quot;has been sent successfully&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onException</span><span class="params">(JMSException e)</span> &#123;</span><br><span class="line">                    System.out.println(msgID + <span class="string">&quot;failed to send&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h2 id="10-2-延时投递"><a href="#10-2-延时投递" class="headerlink" title="10.2 延时投递"></a>10.2 延时投递</h2><table>
<thead>
<tr>
<th>Property name</th>
<th>type</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>AMQ_SCHEDULED_DELAY</td>
<td>long</td>
<td>延迟投递的时间</td>
</tr>
<tr>
<td>AMQ_SCHEDULED_PERIOD</td>
<td>long</td>
<td>重复投递的时间间隔</td>
</tr>
<tr>
<td>AMQ_SCHEDULED_REPEAT</td>
<td>int</td>
<td>重复投递次数</td>
</tr>
<tr>
<td>AMQ_SCHEDULED_CRON</td>
<td>String</td>
<td>Cron表达式</td>
</tr>
</tbody></table>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--activemq.xml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">broker</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://activemq.apache.org/schema/core&quot;</span> <span class="attr">brokerName</span>=<span class="string">&quot;localhost&quot;</span> <span class="attr">dataDirectory</span>=<span class="string">&quot;$&#123;activemq.data&#125;&quot;</span> <span class="attr">schedulerSupport</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">textMessage.setLongProperty(ScheduledMessage.AMQ_SCHEDULED_DELAY,<span class="number">3000</span>);</span><br><span class="line">         textMessage.setLongProperty(ScheduledMessage.AMQ_SCHEDULED_PERIOD,<span class="number">4000</span>);</span><br><span class="line">         textMessage.setIntProperty(ScheduledMessage.AMQ_SCHEDULED_REPEAT,<span class="number">5</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="10-3-消息重试"><a href="#10-3-消息重试" class="headerlink" title="10.3 消息重试"></a>10.3 消息重试</h2><p><strong>引起消息重发的原因</strong></p>
<ol>
<li>Client用了transactions且在session中调用了rollback()</li>
<li>Client用了transactions且在调用commit()之前关闭或者没有commit</li>
<li>Client在CLIENT_ACKNOWLEDGE的传递模式下，在session中调用了recover()</li>
</ol>
<p><strong>重发间隔</strong>：1</p>
<p><strong>重发次数</strong>：6（引起消息重发6次后将不会再重发）</p>
<p><strong>有毒消息</strong>：</p>
<p>一个消息初redelivedred 超过默认的最大重发次数（默认6次）时，消费端会给MQ发送一个”poison ack”告诉broker不要再发了。这个时候 broker 会把这个消息放到 DLQ（死信队列）</p>
<p><img src="/2022/04/04/ActiveMQ/image-20220101161150929.png" alt="image-20220101161150929"></p>
<p><strong>属性</strong></p>
<p><img src="/2022/04/04/ActiveMQ/image-20220101160849517.png" alt="image-20220101160849517"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不整合spring直接set属性</span></span><br><span class="line"><span class="type">RedeliveryPolicy</span> <span class="variable">redeliveryPolicy</span> <span class="operator">=</span> newRedeliveryPolicy(）;</span><br><span class="line">redeliveryPolicy.setMaximumRedeliveries(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/2022/04/04/ActiveMQ/image-20220101162248225.png" alt="image-20220101162248225"></p>
<h2 id="10-4-死信队列"><a href="#10-4-死信队列" class="headerlink" title="10.4 死信队列"></a>10.4 死信队列</h2><p>ActiveMQ中的概念。即一条消息再被重发了多次后（默认为重发6次redeliveryCounter&#x3D;&#x3D;6），将会被ActiveMQ移入“死信队列”。开发人员可以在这个Queue中查看处理出错的消息，进行人工干预</p>
<p><img src="/2022/04/04/ActiveMQ/image-20220101161150929.png" alt="image-20220101161150929"></p>
<p><img src="/2022/04/04/ActiveMQ/image-20220101163114978.png" alt="image-20220101163114978"></p>
<p>将所有的DeadLetter保存在一个共享的队列中，这是ActiveMQ broker端默认的策略。共享队列默认为“ActiveMQ.DLQ”，可以通过“deadLetterQueue”属性来设定。</p>
<p><img src="/2022/04/04/ActiveMQ/image-20220101163651574.png" alt="image-20220101163651574"></p>
<p>也可以指定对应的死信队列</p>
<p><img src="/2022/04/04/ActiveMQ/image-20220101163749051.png" alt="image-20220101163749051"></p>
<p><img src="/2022/04/04/ActiveMQ/image-20220101163737840.png" alt="image-20220101163737840"></p>
<p><img src="/2022/04/04/ActiveMQ/image-20220101163906587.png" alt="image-20220101163906587"><img src="/2022/04/04/ActiveMQ/image-20220101163919118.png" alt="image-20220101163919118"></p>
<h2 id="10-5-保证消息不重复消费"><a href="#10-5-保证消息不重复消费" class="headerlink" title="10.5 保证消息不重复消费"></a>10.5 保证消息不重复消费</h2><p>网络延迟传输中，会造成进行MQ重试中，在重试过程中，可能会造成<strong>重复消费</strong>。</p>
<p>如果消息是做数据库的插入操作，给这个消息做一个<strong>唯一主键</strong>，那么就算出现重复消费的情况，就会导致主键冲突，避免数据库出现脏数据。</p>
<p>如果上面两种情况还不行，准备一个第三服务方来做消费记录。以<strong>redis</strong>为例，给消息分配一个全局id，只要消费过该消息，将&lt;id,message&gt;以K-V形式写入redis。那消费者开始消费前，先去redis中查询有没消费记录即可。</p>
<p><strong>幂等性问题</strong></p>
<p><strong>幂等性：就是用户对于同一操作发起的一次请求或者多次请求的结果是一致的，不会因为多次点击而产生了副作用。</strong>举个最简单的例子，那就是支付，用户购买商品后支付，支付扣款成功，但是返回结果的时候网络异常，此时钱已经扣了，用户再次点击按钮，此时会进行第二次扣款，返回结果成功，用户查询余额发现多扣钱了，流水记录也变成了两条。在以前的单应用系统中，我们只需要把数据操作放入事务中即可，发生错误立即回滚，但是再响应客户端的时候也有可能出现网络中断或者异常等等。</p>
</table></table></table></table></table></table>
    </div>

    
    
    

    
      <div>
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:24px;">-------------本文结束<i class="fa fa-paw"></i>感谢阅读-------------</div>
    
</div>
      </div>
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>丁丁
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://example.com/2022/04/04/ActiveMQ/" title="ActiveMQ">http://example.com/2022/04/04/ActiveMQ/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag"><i class="fa fa-tag"></i> 消息中间件</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/04/04/Git%E5%88%86%E5%B8%83%E5%BC%8F%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6%E7%B3%BB%E7%BB%9F/" rel="prev" title="Git分布式版本控制系统">
      <i class="fa fa-chevron-left"></i> Git分布式版本控制系统
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/04/04/Docker/" rel="next" title="Docker">
      Docker <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#0-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="nav-number">1.</span> <span class="nav-text">0 前置知识</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E5%85%A5%E9%97%A8%E6%A6%82%E8%BF%B0"><span class="nav-number">2.</span> <span class="nav-text">1 入门概述</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%BC%95%E5%85%A5%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-number">2.1.</span> <span class="nav-text">1.1 为什么要引入消息中间件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E4%BB%80%E4%B9%88%E6%98%AF%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-number">2.2.</span> <span class="nav-text">1.2 什么是消息中间件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-%E7%89%B9%E7%82%B9"><span class="nav-number">2.3.</span> <span class="nav-text">1.3 特点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-%E5%AE%98%E7%BD%91"><span class="nav-number">2.4.</span> <span class="nav-text">1.4 官网</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-%E5%AE%89%E8%A3%85%E5%90%AF%E5%8A%A8"><span class="nav-number">2.5.</span> <span class="nav-text">1.5 安装启动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-6-%E5%89%8D%E5%8F%B0%E9%A1%B5%E9%9D%A2"><span class="nav-number">2.6.</span> <span class="nav-text">1.6 前台页面</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-Java%E5%AE%9E%E7%8E%B0ActiveMQ%E9%80%9A%E8%AE%AF"><span class="nav-number">3.</span> <span class="nav-text">2 Java实现ActiveMQ通讯</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E4%BE%9D%E8%B5%96"><span class="nav-number">3.1.</span> <span class="nav-text">2.1 依赖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-JMS%E7%BC%96%E7%A0%81%E6%80%BB%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="nav-number">3.2.</span> <span class="nav-text">2.2 JMS编码总体架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-%E7%9B%AE%E7%9A%84%E5%9C%B0Destination"><span class="nav-number">3.3.</span> <span class="nav-text">2.3 目的地Destination</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0%E6%A1%88%E4%BE%8B"><span class="nav-number">3.4.</span> <span class="nav-text">2.4 队列实现案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-1-%E9%98%9F%E5%88%97%E7%94%9F%E4%BA%A7%E8%80%85"><span class="nav-number">3.4.1.</span> <span class="nav-text">2.4.1 队列生产者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-2-%E9%98%9F%E5%88%97%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-number">3.4.2.</span> <span class="nav-text">2.4.2 队列消费者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-3-%E7%89%B9%E7%82%B9"><span class="nav-number">3.4.3.</span> <span class="nav-text">2.4.3 特点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-%E4%B8%BB%E9%A2%98%E5%AE%9E%E7%8E%B0%E6%A1%88%E4%BE%8B"><span class="nav-number">3.5.</span> <span class="nav-text">2.5 主题实现案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-1-%E5%8F%91%E5%B8%83%E4%B8%BB%E9%A2%98%E7%94%9F%E4%BA%A7%E8%80%85"><span class="nav-number">3.5.1.</span> <span class="nav-text">2.5.1 发布主题生产者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-2-%E8%AE%A2%E9%98%85%E8%AE%A2%E9%98%85%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-number">3.5.2.</span> <span class="nav-text">2.5.2 订阅订阅消费者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-3-%E7%89%B9%E7%82%B9"><span class="nav-number">3.5.3.</span> <span class="nav-text">2.5.3 特点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-6-%E4%B8%A4%E5%A4%A7%E6%A8%A1%E5%BC%8F%E5%AF%B9%E6%AF%94"><span class="nav-number">3.6.</span> <span class="nav-text">2.6 两大模式对比</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-JMS%E8%A7%84%E8%8C%83%E4%B8%8E%E8%90%BD%E5%9C%B0%E4%BA%A7%E5%93%81"><span class="nav-number">4.</span> <span class="nav-text">3 JMS规范与落地产品</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-JMS"><span class="nav-number">4.1.</span> <span class="nav-text">3.1 JMS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E5%85%B6%E4%BB%96%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-number">4.2.</span> <span class="nav-text">3.2  其他消息中间件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E7%BB%84%E6%88%90%E7%BB%93%E6%9E%84%E5%92%8C%E7%89%B9%E7%82%B9"><span class="nav-number">4.3.</span> <span class="nav-text">3.3 组成结构和特点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-%E5%8F%AF%E9%9D%A0%E6%80%A7"><span class="nav-number">4.4.</span> <span class="nav-text">3.4 可靠性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-1-Persistent%E6%8C%81%E4%B9%85%E6%80%A7"><span class="nav-number">4.4.1.</span> <span class="nav-text">3.4.1 Persistent持久性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-2-Transaction%E4%BA%8B%E5%8A%A1"><span class="nav-number">4.4.2.</span> <span class="nav-text">3.4.2 Transaction事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-3-Acknowledge%E7%AD%BE%E6%94%B6"><span class="nav-number">4.4.3.</span> <span class="nav-text">3.4.3 Acknowledge签收</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-4-%E9%9B%86%E7%BE%A4%E4%BF%9D%E8%AF%81"><span class="nav-number">4.4.4.</span> <span class="nav-text">3.4.4 集群保证</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-JMS%E7%82%B9%E5%AF%B9%E7%82%B9%E6%80%BB%E7%BB%93"><span class="nav-number">4.5.</span> <span class="nav-text">3.5 JMS点对点总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-6-JMS%E8%AE%A2%E9%98%85%E5%8F%91%E5%B8%83%E6%80%BB%E7%BB%93"><span class="nav-number">4.6.</span> <span class="nav-text">3.6 JMS订阅发布总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-ActiveMQ%E7%9A%84Broker"><span class="nav-number">5.</span> <span class="nav-text">4 ActiveMQ的Broker</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-Broker"><span class="nav-number">5.1.</span> <span class="nav-text">4.1 Broker</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-%E5%B5%8C%E5%85%A5%E5%BC%8FBroker"><span class="nav-number">5.2.</span> <span class="nav-text">4.2 嵌入式Broker</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-Spring%E6%95%B4%E5%90%88ActiveMQ"><span class="nav-number">6.</span> <span class="nav-text">5 Spring整合ActiveMQ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96"><span class="nav-number">6.1.</span> <span class="nav-text">5.1 添加依赖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">6.2.</span> <span class="nav-text">5.2 配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-%E9%98%9F%E5%88%97%E5%AE%9E%E4%BE%8B"><span class="nav-number">6.3.</span> <span class="nav-text">5.3 队列实例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-1-%E7%94%9F%E4%BA%A7%E8%80%85"><span class="nav-number">6.3.1.</span> <span class="nav-text">5.3.1 生产者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-2-%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-number">6.3.2.</span> <span class="nav-text">5.3.2 消费者</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-4-%E4%B8%BB%E9%A2%98%E5%AE%9E%E4%BE%8B"><span class="nav-number">6.4.</span> <span class="nav-text">5.4 主题实例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-1-%E7%94%9F%E4%BA%A7%E8%80%85"><span class="nav-number">6.4.1.</span> <span class="nav-text">5.4.1 生产者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-2-%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-number">6.4.2.</span> <span class="nav-text">5.4.2 消费者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-3-%E9%85%8D%E7%BD%AE%E7%9B%91%E5%90%AC%E7%A8%8B%E5%BA%8F"><span class="nav-number">6.4.3.</span> <span class="nav-text">5.4.3 配置监听程序</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-SpringBoot%E6%95%B4%E5%90%88ActiveMQ"><span class="nav-number">7.</span> <span class="nav-text">6 SpringBoot整合ActiveMQ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96"><span class="nav-number">7.1.</span> <span class="nav-text">6.1  添加依赖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0"><span class="nav-number">7.2.</span> <span class="nav-text">6.2 队列实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-1-%E7%94%9F%E4%BA%A7%E8%80%85"><span class="nav-number">7.2.1.</span> <span class="nav-text">6.2.1 生产者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-2%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-number">7.2.2.</span> <span class="nav-text">6.2.2消费者</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-%E4%B8%BB%E9%A2%98%E5%AE%9E%E7%8E%B0"><span class="nav-number">7.3.</span> <span class="nav-text">6.3 主题实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-1-%E7%94%9F%E4%BA%A7%E8%80%85"><span class="nav-number">7.3.1.</span> <span class="nav-text">6.3.1 生产者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-2-%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-number">7.3.2.</span> <span class="nav-text">6.3.2 消费者</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-ActiveMQ%E7%9A%84%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE"><span class="nav-number">8.</span> <span class="nav-text">7 ActiveMQ的传输协议</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#7-1-%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">8.1.</span> <span class="nav-text">7.1 是什么</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-2-%E5%B8%B8%E8%A7%81%E6%B6%88%E6%81%AF%E5%8D%8F%E8%AE%AE"><span class="nav-number">8.2.</span> <span class="nav-text">7.2 常见消息协议</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-1-%E9%BB%98%E8%AE%A4TCP"><span class="nav-number">8.2.1.</span> <span class="nav-text">7.2.1 默认TCP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-2-NIO-%EF%BC%88New-I-x2F-O-API%EF%BC%89"><span class="nav-number">8.2.2.</span> <span class="nav-text">7.2.2 NIO （New I&#x2F;O API）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-3-%E5%85%B6%E4%BB%96%E5%8D%8F%E8%AE%AE"><span class="nav-number">8.2.3.</span> <span class="nav-text">7.2.3 其他协议</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-4-%E5%B0%8F%E7%BB%93"><span class="nav-number">8.2.4.</span> <span class="nav-text">7.2.4 小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-3-NIO%E4%BC%A0%E8%BE%93%E6%A1%88%E4%BE%8B%E6%BC%94%E7%A4%BA"><span class="nav-number">8.3.</span> <span class="nav-text">7.3 NIO传输案例演示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-4-NIO%E4%BC%A0%E8%BE%93%E6%A1%88%E4%BE%8B%E6%BC%94%E7%A4%BA%E5%A2%9E%E5%BC%BA"><span class="nav-number">8.4.</span> <span class="nav-text">7.4 NIO传输案例演示增强</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8-ActiveMQ%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8%E4%B8%8E%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-number">9.</span> <span class="nav-text">8 ActiveMQ消息存储与持久化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8-1-%E7%AE%80%E4%BB%8B"><span class="nav-number">9.1.</span> <span class="nav-text">8.1 简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-2-%E5%AD%98%E5%82%A8%E6%96%B9%E5%BC%8F"><span class="nav-number">9.2.</span> <span class="nav-text">8.2 存储方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-1-AMQ-Message-Store-%E4%BA%86%E8%A7%A3"><span class="nav-number">9.2.1.</span> <span class="nav-text">8.2.1 AMQ Message Store(了解)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-2-KahaDB%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8-%E9%BB%98%E8%AE%A4"><span class="nav-number">9.2.2.</span> <span class="nav-text">8.2.2 KahaDB消息存储(默认)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-3-JDBC%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8"><span class="nav-number">9.2.3.</span> <span class="nav-text">8.2.3 JDBC消息存储</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-4-LevelDB%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="nav-number">9.2.4.</span> <span class="nav-text">8.2.4 LevelDB消息存储（了解）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-5-JDBC-Message-store-with-ActiveMQ-Journal"><span class="nav-number">9.2.5.</span> <span class="nav-text">8.2.5 JDBC Message store with ActiveMQ Journal</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-3-JDBC%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8"><span class="nav-number">9.3.</span> <span class="nav-text">8.3 JDBC消息存储</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-1-lib%E6%96%87%E4%BB%B6%E5%A4%B9%E4%B8%AD%E6%B7%BB%E5%8A%A0%E6%95%B0%E6%8D%AE%E5%BA%93%E9%A9%B1%E5%8A%A8jar%E5%8C%85"><span class="nav-number">9.3.1.</span> <span class="nav-text">8.3.1 lib文件夹中添加数据库驱动jar包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-2-%E4%BF%AE%E6%94%B9activemq-xml%E7%9A%84%E6%8C%81%E4%B9%85%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="nav-number">9.3.2.</span> <span class="nav-text">8.3.2 修改activemq.xml的持久化配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-3-%E6%95%B0%E6%8D%AE%E6%BA%90%E9%85%8D%E7%BD%AE"><span class="nav-number">9.3.3.</span> <span class="nav-text">8.3.3 数据源配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-4-MySQL%E6%8E%88%E4%BA%88%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5%E7%9A%84%E6%9D%83%E9%99%90"><span class="nav-number">9.3.4.</span> <span class="nav-text">8.3.4 MySQL授予远程连接的权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-5-%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E5%B9%B6%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E8%A1%A8"><span class="nav-number">9.3.5.</span> <span class="nav-text">8.3.5 创建数据库并自动生成表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-6-%E4%BB%A3%E7%A0%81%E9%AA%8C%E8%AF%81%E4%BB%A5%E5%8F%8A%E6%95%B0%E6%8D%AE%E5%BA%93%E6%83%85%E5%86%B5"><span class="nav-number">9.3.6.</span> <span class="nav-text">8.3.6 代码验证以及数据库情况</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-7-%E5%A1%AB%E5%9D%91"><span class="nav-number">9.3.7.</span> <span class="nav-text">8.3.7 填坑</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-4-JDBC-Message-store-with-ActiveMQ-Journal"><span class="nav-number">9.4.</span> <span class="nav-text">8.4 JDBC Message store with ActiveMQ Journal</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-5-%E6%8C%81%E4%B9%85%E5%8C%96%E6%9C%BA%E5%88%B6%E6%80%BB%E7%BB%93"><span class="nav-number">9.5.</span> <span class="nav-text">8.5 持久化机制总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#9-ActiveMQ%E7%9A%84%E5%A4%9A%E8%8A%82%E7%82%B9%E9%9B%86%E7%BE%A4"><span class="nav-number">10.</span> <span class="nav-text">9 ActiveMQ的多节点集群</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#9-1-%E4%B8%89%E7%A7%8D%E9%9B%86%E7%BE%A4%E6%96%B9%E5%BC%8F"><span class="nav-number">10.1.</span> <span class="nav-text">9.1 三种集群方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-2-%E5%9F%BA%E4%BA%8EReplicated-Level-DB%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE%E9%83%A8%E7%BD%B2"><span class="nav-number">10.2.</span> <span class="nav-text">9.2 基于Replicated Level DB集群配置部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-1-%E7%8E%AF%E5%A2%83"><span class="nav-number">10.2.1.</span> <span class="nav-text">9.2.1 环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-2-%E5%8D%95%E6%9C%BA%E9%83%A8%E7%BD%B2%E8%A7%84%E5%88%92"><span class="nav-number">10.2.2.</span> <span class="nav-text">9.2.2 单机部署规划</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-3-%E9%85%8D%E7%BD%AEzk%E9%9B%86%E7%BE%A4"><span class="nav-number">10.2.3.</span> <span class="nav-text">9.2.3 配置zk集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-4-%E5%88%9B%E5%BB%BAmq%E9%9B%86%E7%BE%A4%E7%9B%AE%E5%BD%95"><span class="nav-number">10.2.4.</span> <span class="nav-text">9.2.4 创建mq集群目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-5-%E4%BF%AE%E6%94%B9%E7%AE%A1%E7%90%86%E5%89%8D%E5%8F%B0%E7%9A%84%E7%AB%AF%E5%8F%A3"><span class="nav-number">10.2.5.</span> <span class="nav-text">9.2.5 修改管理前台的端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-6-%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE"><span class="nav-number">10.2.6.</span> <span class="nav-text">9.2.6 集群配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-7-%E4%BF%AE%E6%94%B9%E6%B6%88%E6%81%AF%E7%AB%AF%E5%8F%A3"><span class="nav-number">10.2.7.</span> <span class="nav-text">9.2.7 修改消息端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-8-%E5%90%AF%E5%8A%A8zk%E9%9B%86%E7%BE%A4%E5%90%8E%E5%90%AF%E5%8A%A8mq%E9%9B%86%E7%BE%A4"><span class="nav-number">10.2.8.</span> <span class="nav-text">9.2.8 启动zk集群后启动mq集群</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-3-%E9%9B%86%E7%BE%A4%E5%8F%AF%E7%94%A8%E6%80%A7%E6%B5%8B%E8%AF%95"><span class="nav-number">10.3.</span> <span class="nav-text">9.3 集群可用性测试</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#10-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7%E4%B8%8E%E9%9D%A2%E8%AF%95"><span class="nav-number">11.</span> <span class="nav-text">10 高级特性与面试</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#10-1-%E5%BC%82%E6%AD%A5%E6%8A%95%E9%80%92"><span class="nav-number">11.1.</span> <span class="nav-text">10.1 异步投递</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-2-%E5%BB%B6%E6%97%B6%E6%8A%95%E9%80%92"><span class="nav-number">11.2.</span> <span class="nav-text">10.2 延时投递</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-3-%E6%B6%88%E6%81%AF%E9%87%8D%E8%AF%95"><span class="nav-number">11.3.</span> <span class="nav-text">10.3 消息重试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-4-%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97"><span class="nav-number">11.4.</span> <span class="nav-text">10.4 死信队列</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-5-%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E4%B8%8D%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9"><span class="nav-number">11.5.</span> <span class="nav-text">10.5 保证消息不重复消费</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="丁丁"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">丁丁</p>
  <div class="site-description" itemprop="description">想睡的时候能睡着</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/tintinly" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;tintinly" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/ding-ding-67-71-21" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;ding-ding-67-71-21" rel="noopener" target="_blank"><i class="fa fa-search fa-fw"></i>Zhihu</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/u/6461790992" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;6461790992" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/weixin_45815788" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;weixin_45815788" rel="noopener" target="_blank"><i class="fa fa-code fa-fw"></i>CSDN</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2022-04 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">丁丁</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">141k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">2:08</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>



    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <span id="busuanzi_container_site_pv">总访问量<span id="busuanzi_value_site_pv"></span>次</span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_uv">总访客数<span id="busuanzi_value_site_uv"></span>人</span>
    <span class="post-meta-divider">|</span>
<!-- 不蒜子计数初始值纠正 -->
<script>
$(document).ready(function() {

    var int = setInterval(fixCount, 50);  // 50ms周期检测函数
    var countOffset = 20000;  // 初始化首次数据

    function fixCount() {            
       if (document.getElementById("busuanzi_container_site_pv").style.display != "none")
        {
            $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + countOffset); 
            clearInterval(int);
        }                  
        if ($("#busuanzi_container_site_pv").css("display") != "none")
        {
            $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + countOffset); // 加上初始数据 
            clearInterval(int); // 停止检测
        }  
    }
       	
});
</script> 

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'PFljDxR0Q9DIjrqrI1KC61n5-gzGzoHsz',
      appKey     : '62eMAFVIEcPIQkulk2C3a9gP',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
